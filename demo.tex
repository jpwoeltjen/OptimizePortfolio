
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    \usepackage{mathrsfs}
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}
    \definecolor{ansi-default-inverse-fg}{HTML}{FFFFFF}
    \definecolor{ansi-default-inverse-bg}{HTML}{000000}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatibility definitions
    \def\gt{>}
    \def\lt{<}
    \let\Oldtex\TeX
    \let\Oldlatex\LaTeX
    \renewcommand{\TeX}{\textrm{\Oldtex}}
    \renewcommand{\LaTeX}{\textrm{\Oldlatex}}
    % Document parameters
    % Document title
    \title{A Simulation Based Approach to Portfolio Optimization}
    
    
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \hypertarget{portfolio-optimization}{%
\section{Portfolio Optimization}\label{portfolio-optimization}}

    In the following I will investigate several portfolio optimization
methods by means of Monte Carlo simulation. In particular, I will
compare Markowitz mean-variance optimization based on sample moments
with industry-neutral equal weighting as a baseline. Further, I will
explore a hierarchical method and principal component analysis as a
means to reduce estimation error of the covariance matrix. These methods
can improve upon Markowitz optimization and equal weighting both under
Gaussian and fat-tailed noise distributions.

Let's simulate a bunch of stocks belonging to different industries. Each
stock is composed of a deterministic trend \(\mu\), a loading on the
market related stochastic trend \(\beta_{market}\) and a loading on the
industry specific stochastic trend \(\beta_{industry}\). For each stock,
\(\mu\), \(\beta_{market}\), and \(\beta_{industry}\) are sampled from a
uniform distribution. In the first simulation, I compare a mean-variance
optimization with a naive diversification approach where each asset is
equally weighted with the sign of the expected value. At this point I
should emphasize that I assume perfect knowledge of the expected value.
Traditionally, the expected value is estimated by the in-sample first
moment of the asset. In my example, this would actually make sense since
the mean is a consistent estimator of the deterministic trend. In
practice, however, there is probably not a constant deterministic trend.
This is where the alpha model steps in, which is not the topic of this
study and thus assumed given.

The return of each stock is thus given by

\[\begin{aligned} R_{i t} &=\mu_{i}+\beta_{i 1} f_{1 t}+\beta_{i 2} f_{2 t}+\cdots+\beta_{i k} f_{k t}+\epsilon_{i t} \\ &=\mu_{i}+\sum_{\ell=1}^{k} \beta_{i \ell} f_{\ell t}+\epsilon_{i t}, \quad i=1, \ldots, N, \quad t=1, \ldots, T \end{aligned}\]

\(\begin{array}{l}{R_{i t} \text { is the return of asset } i \text { at time } t, i=1, \ldots, N} \\ {f_{\ell t} \text { is the } \ell \text { th common factor at time } t, \ell=1, \ldots, k} \\ {\beta_{i \ell} \text { is the factor loading or factor beta of asset } i \text { with respect to factor }} \\ {\ell, i=1, \ldots, N, \ell=1, \ldots, k} \\ {\epsilon_{i t} \text { is the asset-specific factor or asset-specific risk. }}\end{array}\)

\(\begin{array}{l}{\text { The } k \times k \text { covariance matrix of the factors is }} \\ {\qquad \operatorname{Cov}\left(\boldsymbol{f}_{t}\right)=\boldsymbol{\Sigma}_{f}} \\ {\text { where }} \\ {\qquad \boldsymbol{f}_{t}=\left[f_{1 t}, f_{2 t}, \ldots, f_{k t}\right]^{\prime}}\end{array}\)

\(\text {Asset-specific noise is uncorrelated with the factors } \operatorname{Cov}\left(f_{\ell t}, \epsilon_{i t}\right)=0, \quad \ell=1, \ldots, k, \quad i=1, \ldots, N, \quad t=1, \ldots, T\),

\(\boldsymbol{\Sigma}_{\boldsymbol{\epsilon}}=\operatorname{Cov}\left(\boldsymbol{\epsilon}_{t}\right)=\left[\begin{array}{cccc}{\sigma_{\epsilon_{1}}^{2}} & {0} & {\cdots} & {0} \\ {0} & {\sigma_{\epsilon_{2}}^{2}} & {\cdots} & {0} \\ {\vdots} & {\vdots} & {\ddots} & {\vdots} \\ {0} & {0} & {\cdots} & {\sigma_{\epsilon_{N}}^{2}}\end{array}\right]=\operatorname{diag}\left(\sigma_{\epsilon_{1}}^{2}, \sigma_{\epsilon_{2}}^{2}, \ldots, \sigma_{\epsilon_{N}}^{2}\right)\),

\(\begin{array}{l}{\text { The asset-specific risks are likewise uncorrelated across assets, and for }} \\ {\text { each asset they are serially uncorrelated, }} \\ {\qquad \operatorname{Cov}\left(\epsilon_{i t}, \epsilon_{j t^{\prime}}\right)=\left\{\begin{array}{ll}{\sigma_{i}^{2}} & {\text { if } i=j \text { and } t=t^{\prime}} \\ {0} & {\text { otherwise }}\end{array}\right.}\end{array}\)

Thus a diagonal covariance structure reflects the assumption that all
correlation between assets is due to the factors.

\(\begin{array}{l}{\text { If we write the factor model as }} \\ {\qquad \boldsymbol{R}_{t}=\boldsymbol{\alpha}+\boldsymbol{B} \boldsymbol{f}_{t}+\boldsymbol{\epsilon}_{t}, \quad t=1, \ldots, T}\end{array}\)

\(\begin{array}{l}{\text { where in the } N \times k \text { matrix }} \\ {\qquad B=\left[\begin{array}{c}{\boldsymbol{\beta}_{1}^{\prime}} \\ {\boldsymbol{\beta}_{2}^{\prime}} \\ {\vdots} \\ {\boldsymbol{\beta}_{N}^{\prime}}\end{array}\right]=\left[\begin{array}{cccc}{\beta_{11}} & {\beta_{12}} & {\cdots} & {\beta_{1 k}} \\ {\beta_{21}} & {\beta_{22}} & {\cdots} & {\beta_{2 k}} \\ {\vdots} & {\vdots} & {\ddots} & {\vdots} \\ {\beta_{N 1}} & {\beta_{N 2}} & {\cdots} & {\beta_{N k}}\end{array}\right]} \\ {\text { the }} \ell {\text {th column contains the beta coefficients associated with factor } \ell}\end{array}\)

\(\begin{array}{l}{\text { The covariance matrix of the returns } R_{t}=\left[R_{1 t}, R_{2 t}, \ldots, R_{N t}\right] \text { implied }} \\ {\text { by the factor model is }} \\ {\qquad \Sigma=\operatorname{Cov}\left(R_{t}\right)=B \Sigma_{f} B^{\prime}+\Sigma_{\epsilon}}\end{array}\)

\(\begin{array}{l}{\text { That is, }} \\ {\qquad \begin{aligned} \operatorname{Var}\left(R_{i}\right) &=\beta_{i}^{\prime} \Sigma_{f} \beta_{i}+\sigma_{\epsilon_{i}}^{2} \\ \operatorname{Cov}\left(R_{i}, R_{j}\right) &=\beta_{i}^{\prime} \Sigma_{f} \beta_{j} \end{aligned}}\end{array}\)

\(\begin{array}{l}{\text { Since the factors are uncorrelated in this simulation, the covariance matrix }\text { simplifies to}} \\ {\qquad \Sigma=B \Sigma_{f} B^{\prime}+\Sigma_{\epsilon}=\sum_{\ell=1}^{k} \beta_{\ell} \beta_{\ell}^{\prime} e_{f_{\ell}}^{2}+\Sigma_{\epsilon}}\end{array}\)

\(\begin{array}{l}{\text { where }} \\ {\beta_{\ell} \text { is the vector of loadings with respect to factor } \ell, \text { i.e. the } \ell \text { th column }} \\ {\text { of matrix } \boldsymbol{B} \text { , }} \\ {\sigma_{f_{\ell}}^{2} \text { is the variance of factor } \ell}\end{array}\)

\(\text { Thus the variance of asset } i \text { is }\)
\[\sigma_{i}^{2}=\sum_{\ell=1}^{k} \beta_{i \ell}^{2} \sigma_{f_{\ell}}^{2}+\sigma_{\epsilon_{i}}^{2} \]

\(\text { and the covariance between the returns of assets } i \text { and } j \text { is }\)
\[ \sigma_{i j}=\sum_{\ell=1}^{k} \beta_{i \ell} \beta_{j \ell} \sigma_{f_{\ell}}^{2}\]

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}1}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{k+kn}{import} \PY{n+nn}{pandas} \PY{k}{as} \PY{n+nn}{pd}
        \PY{k+kn}{from} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{linalg} \PY{k}{import} \PY{n}{eigh}\PY{p}{,} \PY{n}{cholesky}
        \PY{k+kn}{from} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{stats} \PY{k}{import} \PY{n}{norm}
        \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{pyplot} \PY{k}{as} \PY{n}{plt}
        \PY{n}{plt}\PY{o}{.}\PY{n}{style}\PY{o}{.}\PY{n}{use}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seaborn}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} \PYZpc{}matplotlib notebook}
        \PY{k+kn}{from} \PY{n+nn}{src} \PY{k}{import} \PY{n}{optimize}
        \PY{k+kn}{from} \PY{n+nn}{src}\PY{n+nn}{.}\PY{n+nn}{portfolio} \PY{k}{import} \PY{n}{Portfolio}
        
        
        \PY{k}{def} \PY{n+nf}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{industry\PYZus{}name}\PY{p}{,} \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{)}\PY{p}{:}
            \PY{n}{mu} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{n}{p\PYZus{}year}
            \PY{n}{beta\PYZus{}market} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{stocks} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
        
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{:}
                \PY{n}{normal\PYZus{}noise} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma\PYZus{}noise}
                \PY{n}{stocks}\PY{p}{[}\PY{n}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+si}{\PYZob{}industry\PYZus{}name\PYZcb{}}\PY{l+s+s1}{\PYZus{}stock\PYZus{}}\PY{l+s+si}{\PYZob{}i\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{mu}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{market} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{industry} \PY{o}{+}
                                                        \PY{n}{normal\PYZus{}noise}\PY{p}{)}
            \PY{n}{mu}\PY{o}{.}\PY{n}{index} \PY{o}{=} \PY{n}{stocks}\PY{o}{.}\PY{n}{columns}
            \PY{k}{return} \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry}
        
        
        \PY{k}{def} \PY{n+nf}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{sigma\PYZus{}sq\PYZus{}0}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{alpha}\PY{p}{,} \PY{n}{beta}\PY{p}{,} \PY{n}{omega}\PY{p}{)}\PY{p}{:}
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{} generate GARCH log returns \PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{nu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{normal}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{n}{n}\PY{p}{)}
            \PY{n}{r} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{epsilon} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{sigma\PYZus{}sq} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{sigma\PYZus{}sq\PYZus{}0}
        
            \PY{k}{if} \PY{n+nb}{min}\PY{p}{(}\PY{n}{alpha}\PY{p}{,} \PY{n}{beta}\PY{p}{)} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{:}
                \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{alpha, beta need to be non\PYZhy{}negative}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{k}{if} \PY{n}{omega} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{l+m+mi}{0}\PY{p}{:}
                \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{omega needs to be positive}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{alpha}\PY{o}{+}\PY{n}{beta} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{1}\PY{p}{:}
                \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{alpha+beta\PYZgt{}=1, variance not defined \PYZhy{}\PYZhy{}\PYZgt{}}\PY{l+s+se}{\PYZbs{}}
        \PY{l+s+s1}{              time series will not be weakly stationary}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n}\PY{p}{)}\PY{p}{:}
        
                \PY{k}{if} \PY{n}{i} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
                    \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{omega} \PY{o}{+}
                                   \PY{n}{alpha} \PY{o}{*} \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+}
                                   \PY{n}{beta} \PY{o}{*} \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        
                \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)} \PY{o}{*} \PY{n}{nu}\PY{p}{[}\PY{n}{i}\PY{p}{]}
        
                \PY{n}{r}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{mu} \PY{o}{+} \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{p}{]}
            \PY{k}{return} \PY{n}{r}
        
        
        \PY{k}{def} \PY{n+nf}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{industry\PYZus{}name}\PY{p}{,}
                                      \PY{n}{sigma\PYZus{}noise}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{,} \PY{n}{garch\PYZus{}mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,}
                                      \PY{n}{garch\PYZus{}alpha}\PY{o}{=}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{o}{=}\PY{l+m+mf}{0.4}\PY{p}{)}\PY{p}{:}
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{} Generate stocks of given industry with fat\PYZhy{}tailed noise. \PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{mu} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{n}{p\PYZus{}year}
            \PY{n}{beta\PYZus{}market} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{stocks} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
            \PY{n}{garch\PYZus{}noise} \PY{o}{=} \PY{n}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                               \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,}
                                               \PY{n}{garch\PYZus{}mu}\PY{p}{,} \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{,}
                                               \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{:}
                \PY{n}{garch\PYZus{}noise} \PY{o}{=} \PY{n}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                                   \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,}
                                                   \PY{n}{garch\PYZus{}mu}\PY{p}{,} \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{,}
                                                   \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
        
                \PY{n}{stocks}\PY{p}{[}\PY{n}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+si}{\PYZob{}industry\PYZus{}name\PYZcb{}}\PY{l+s+s1}{\PYZus{}stock\PYZus{}}\PY{l+s+si}{\PYZob{}i\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{mu}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{market} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{industry} \PY{o}{+}
                                                        \PY{n}{garch\PYZus{}noise}\PY{p}{)}
            \PY{n}{mu}\PY{o}{.}\PY{n}{index} \PY{o}{=} \PY{n}{stocks}\PY{o}{.}\PY{n}{columns}
            \PY{k}{return} \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry}
        
        
        \PY{k}{def} \PY{n+nf}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{equity\PYZus{}curve}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{)}\PY{p}{:}
            \PY{k}{return} \PY{n}{equity\PYZus{}curve}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{)}\PY{o}{/}\PY{n}{equity\PYZus{}curve}\PY{o}{.}\PY{n}{std}\PY{p}{(}\PY{p}{)}\PY{o}{*}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        
        \PY{k}{def} \PY{n+nf}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{log\PYZus{}returns}\PY{p}{)}\PY{p}{:}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{exp}\PY{p}{(}\PY{n}{log\PYZus{}returns}\PY{o}{.}\PY{n}{cumsum}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equity Curve}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Period}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equity Value}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
        
        
        \PY{k}{def} \PY{n+nf}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{long\PYZus{}only}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{:}
            \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
            \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
            \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        
            \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}
                \PY{n}{n\PYZus{}stocks}\PY{p}{,}
                \PY{n}{market}\PY{p}{,}
                \PY{n+nb}{list}\PY{p}{(}\PY{n}{industry}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                \PY{n+nb}{list}\PY{p}{(}\PY{n}{industry}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                \PY{n}{p\PYZus{}year}\PY{p}{)}
        
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{long\PYZus{}only}\PY{p}{:}
                \PY{n}{lower\PYZus{}bound} \PY{o}{=} \PY{l+m+mi}{0}
                \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{mu}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{k}{lambda} \PY{n}{x}\PY{p}{:} \PY{l+m+mi}{0} \PY{k}{if} \PY{n}{x} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{l+m+mi}{0} \PY{k}{else} \PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{n}{mu}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                \PY{n}{market\PYZus{}neutral} \PY{o}{=} \PY{k+kc}{False}
            \PY{k}{else}\PY{p}{:}
                \PY{n}{lower\PYZus{}bound} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
                \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{mu}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{mu}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                \PY{n}{market\PYZus{}neutral} \PY{o}{=} \PY{k+kc}{True}
        
            \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{mu}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{n}{market\PYZus{}neutral}\PY{p}{,}
                                                  \PY{p}{(}\PY{n}{lower\PYZus{}bound}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{mu}\PY{p}{,} \PY{n}{stocks}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} Make same gross leverage}
            \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,} \PY{n}{equal\PYZus{}weights}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,} \PY{n}{equal\PYZus{}weights}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
        
            \PY{k}{return} \PY{n}{weights}
        
        
        
        \PY{n}{p\PYZus{}year} \PY{o}{=} \PY{l+m+mi}{250}
        \PY{n}{num\PYZus{}samples} \PY{o}{=} \PY{n}{p\PYZus{}year}\PY{o}{*}\PY{l+m+mi}{4}
        
        \PY{n}{sigma} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.14}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.07}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.2}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.12}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.22}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.05}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.125}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        \PY{n}{sigma\PYZus{}noise} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        \PY{n}{MC\PYZus{}RUNS} \PY{o}{=} \PY{l+m+mi}{10}
        \PY{n}{PLOT\PYZus{}STOCKS} \PY{o}{=} \PY{k+kc}{False}
\end{Verbatim}

    The results below show that out-of-sample (oos) performance of the
optimized portfolio using sample moments (sm) is decent if the number of
assets is relatively small. It definitely beats equal weighting (equal).

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}2}]:} \PY{n}{industry} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        \PY{n}{industry}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_4_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  14.274032129538938

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_4_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  5.721563189877289

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_4_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  7.637887456929092

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_4_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  5.721563189877289

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_4_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    As shown below, long-only performance, of course, is horrendous. This is
due to the fact that we cannot diversify the systematic risk. Since we
cannot short, hedging out that risk is also not possible. Hence, our
bets are not independent and the Law of Large Numbers does not apply.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}3}]:} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{,} \PY{n}{long\PYZus{}only}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_6_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  0.5853880251555333

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_6_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  -0.6123757070640578

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_6_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  0.5164220402938328

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_6_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  -0.6123757070640578

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_6_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Standard mean-variance optimization works well if the number of assets
is relatively small. When the number of assets is relatively large,
however, the out-of-sample performance is significantly worse than the
in-sample performance as demonstrated by the information ratio (IR).
Even the very naive approach of equal weighting beats mean-variance
optimization out-of-sample embarrassingly often.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}4}]:} \PY{n}{weights} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{300}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_8_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  26.949248378797808

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_8_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  10.425697654396167

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_8_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  11.796260598862835

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_8_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  10.425697654396167

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_8_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}5}]:} \PY{c+c1}{\PYZsh{} creating portfolio object}
        \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                       \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                       \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 300 Assets, \$35.69 Long, \$35.69 Short
largest long: manufacturing\_stock\_35 0.7470542974614564
largest short: manufacturing\_stock\_171 -0.686910165001864

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}6}]:} \PY{c+c1}{\PYZsh{} Showing the first 5 positions in portfolio}
        \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{head}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}6}]:}                          position  price  factor\_value  sector\_id  \textbackslash{}
        manufacturing\_stock\_35   0.747054      1           1.0        0.0   
        manufacturing\_stock\_227  0.618434      1           1.0        0.0   
        manufacturing\_stock\_12   0.587384      1           1.0        0.0   
        manufacturing\_stock\_256  0.579406      1           1.0        0.0   
        manufacturing\_stock\_125  0.555688      1           1.0        0.0   
        
                                 position\_value  
        manufacturing\_stock\_35         0.747054  
        manufacturing\_stock\_227        0.618434  
        manufacturing\_stock\_12         0.587384  
        manufacturing\_stock\_256        0.579406  
        manufacturing\_stock\_125        0.555688  
\end{Verbatim}
            
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}7}]:} \PY{c+c1}{\PYZsh{} Plotting the weight distribution}
        \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Position Allocation}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ordered Positions}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Weight}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_11_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Here you can see a typical result of mean-variance optimization. There
are some very large positions. These are most likely due to estimation
errors of the covariance matrix and thus undesirable. This problem is
even greater when \(\mu\), too, is estimated with error. As the number
of assets grows, there is a higher likelihood of observing an extreme
covariance value by chance and thus this problem actually grows with the
number of assets. This is so common that it has a name. In the
literature it goes by `Error Maximization'.

    \hypertarget{imposing-structure}{%
\subsection{Imposing Structure}\label{imposing-structure}}

To reduce Error Maximization we need to impose structure. One way to do
this is by using our knowledge that stocks usually cluster (e.g., into
certain industries). It seems like a good idea to encode this prior
knowledge by mean-variance optimize stocks within clusters and then
optimize allocation to these clusters. This is pursued next and compared
to the standard optimization.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}8}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
        \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
        \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
        
        \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
        
            \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
        \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        
            \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        
            \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
            \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
        
            \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
            \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                    \PY{n}{market}\PY{p}{,}
                                                                    \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                    \PY{n}{i}\PY{p}{,}
                                                                    \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                    \PY{n}{p\PYZus{}year}\PY{p}{)}
        
                \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        
                \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,} \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
        
                \PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}
                     \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                     \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                     \PY{k+kc}{True}\PY{p}{,}
                     \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                     \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                     \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
                \PY{n}{industries\PYZus{}portfolio}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}
                    \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                    \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} ground thruth}
            \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
            \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
            \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
            \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
            \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
            \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} standard sample moments}
            \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,}
                                                  \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
            \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
            \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} hierarchical}
            \PY{c+c1}{\PYZsh{} optimize allocation to industry}
            \PY{n}{industry\PYZus{}weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}
                \PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                \PY{k+kc}{False}\PY{p}{,}
                \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{index}\PY{o}{=}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                \PY{n}{data}\PY{o}{=}\PY{p}{[}\PY{l+m+mf}{0.1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{p}{,}
                \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{}     \PYZsh{} equal weighting industries}
        \PY{c+c1}{\PYZsh{}     for i in industry\PYZus{}weights.keys():}
        \PY{c+c1}{\PYZsh{}         industry\PYZus{}weights[i] = 1/len(industries)}
        
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{p}{)}
            \PY{n}{portfolio\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                    \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                    \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
        
            \PY{c+c1}{\PYZsh{} Make same gross leverage}
            \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                    \PY{n}{equal\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{)}
            \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is:  22.97727534341568
IR gt\_oos:  25.601650253512382

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  68.86642974717553
IR sm\_oos:  6.699566592572767
\{'banks': 0.08525765766039736, 'oil': 0.026799533838017413, 'insurance':
0.020444231421016416, 'tech': 0.117966834969583, 'bio': 0.30235562609587247, 'pharma':
0.06960329827570759, 'auto': 0.14206749885277828, 'retail': 0.19377667069590016,
'manufacturing': 0.041728648190727496\}
IR hier\_is:  20.8116940244627
IR hier\_oos:  21.865542855743392
IR equal\_is:  7.95182566091046
IR equal\_oos:  7.326006935456171
MC run:  1
IR gt\_is:  26.771132066373774
IR gt\_oos:  28.159064152018402
IR sm\_is:  110.09206477273513
IR sm\_oos:  7.5479680514651175
\{'banks': 0.044190128115900604, 'oil': 0.1276822372866994, 'insurance':
0.038706296568006365, 'tech': 0.06337915844064392, 'bio': 0.13878794406853137,
'pharma': 0.07518201151804653, 'auto': 0.07711013777617716, 'retail':
0.25935387414437844, 'manufacturing': 0.1756082120816163\}
IR hier\_is:  25.662726830273943
IR hier\_oos:  25.388872828147313
IR equal\_is:  13.832612014560612
IR equal\_oos:  13.870769920429083
MC run:  2
IR gt\_is:  22.12498465423602
IR gt\_oos:  24.994628015545
IR sm\_is:  73.95084565620881
IR sm\_oos:  7.313627885190998
\{'banks': 0.09533003742104401, 'oil': 0.13281804748440268, 'insurance':
0.010599084773217502, 'tech': 0.1870967422369644, 'bio': 0.0430765017518334, 'pharma':
0.019647395250293832, 'auto': 0.06477985552847948, 'retail': 0.21783365245635233,
'manufacturing': 0.22881868309741218\}
IR hier\_is:  21.445295159373668
IR hier\_oos:  21.74898654991655
IR equal\_is:  13.022774599594436
IR equal\_oos:  13.431445532802027
MC run:  3
IR gt\_is:  24.783685587866106
IR gt\_oos:  23.964302612640793
IR sm\_is:  76.90436023202933
IR sm\_oos:  9.289079575452817
\{'banks': 0.10178730748467713, 'oil': 0.12063615385680393, 'insurance':
0.007842505585361351, 'tech': 0.13095328977379267, 'bio': 0.15555816144859244,
'pharma': 0.2647333159484891, 'auto': 0.04527157255757351, 'retail':
0.15598235608121774, 'manufacturing': 0.01723533726349217\}
IR hier\_is:  23.11903322407622
IR hier\_oos:  20.709967158211672
IR equal\_is:  12.245319437972624
IR equal\_oos:  11.768506071460667
MC run:  4
IR gt\_is:  25.405717149410922
IR gt\_oos:  23.83151324844424
IR sm\_is:  71.91830187636323
IR sm\_oos:  7.893799804413511
\{'banks': 0.008331797624099297, 'oil': 0.1422152742418836, 'insurance':
0.07117306958746743, 'tech': 0.05683536741120898, 'bio': 0.03093410182989959,
'pharma': 0.30839849778761186, 'auto': 0.029121474729654418, 'retail':
0.16156160489816657, 'manufacturing': 0.1914288118900083\}
IR hier\_is:  22.047307244967097
IR hier\_oos:  19.74034703920951
IR equal\_is:  10.24930695194757
IR equal\_oos:  9.26763811882215
MC run:  5
IR gt\_is:  23.774046760263385
IR gt\_oos:  24.416799220816827
IR sm\_is:  82.51159270276858
IR sm\_oos:  7.073926437980247
\{'banks': 0.019026711412274785, 'oil': 0.10069088719525802, 'insurance':
0.01738849710027885, 'tech': 0.3363406418462935, 'bio': 0.11936447738914333, 'pharma':
0.1903819517161351, 'auto': 0.05639672497940893, 'retail': 0.12447721248140026,
'manufacturing': 0.03593289587980716\}
IR hier\_is:  21.524876253053215
IR hier\_oos:  20.608853356276203
IR equal\_is:  10.847118607900063
IR equal\_oos:  9.382224029908766
MC run:  6
IR gt\_is:  22.871741160100328
IR gt\_oos:  22.487076322170182
IR sm\_is:  64.75344379654321
IR sm\_oos:  6.323567513587528
\{'banks': 0.17029698533312862, 'oil': 0.21106271552184303, 'insurance':
0.042080354837382324, 'tech': 0.03008387395067035, 'bio': 0.007005001847849584,
'pharma': 0.3297258523256762, 'auto': 0.08767800263458783, 'retail':
0.01150600681945518, 'manufacturing': 0.11056120672940697\}
IR hier\_is:  20.82868495138105
IR hier\_oos:  18.00323300546353
IR equal\_is:  8.029881843476653
IR equal\_oos:  7.893597017400724
MC run:  7
IR gt\_is:  22.9079517433364
IR gt\_oos:  23.2071757725262
IR sm\_is:  76.91780583251605
IR sm\_oos:  6.088767171800019
\{'banks': 0.007013241716007736, 'oil': 0.18128528150435333, 'insurance':
0.011100832403692869, 'tech': 0.008538933940442348, 'bio': 0.12330362371058244,
'pharma': 0.35716281397695776, 'auto': 0.09910541317827144, 'retail':
0.19539604560933388, 'manufacturing': 0.01709381396035819\}
IR hier\_is:  18.953515732558117
IR hier\_oos:  17.30131100375008
IR equal\_is:  5.550279675144221
IR equal\_oos:  4.445961826692587
MC run:  8
IR gt\_is:  23.605123461477735
IR gt\_oos:  23.264781570255654
IR sm\_is:  66.61738057882724
IR sm\_oos:  6.43578242236054
\{'banks': 0.06607187976300144, 'oil': 0.04501823053835708, 'insurance':
0.11938848460520698, 'tech': 0.023104508754752045, 'bio': 0.09762295910249473,
'pharma': 0.18800636988316546, 'auto': 0.02543435582262118, 'retail':
0.21784042489955452, 'manufacturing': 0.21751278663084656\}
IR hier\_is:  23.804200363766427
IR hier\_oos:  20.762433881352706
IR equal\_is:  7.8827421616603885
IR equal\_oos:  8.720606082070747
MC run:  9
IR gt\_is:  23.85084213207428
IR gt\_oos:  26.2639814301371
IR sm\_is:  81.30892790285837
IR sm\_oos:  7.701145910218168
\{'banks': 0.03027463504519667, 'oil': 0.1856023565331236, 'insurance':
0.019317517946394445, 'tech': 0.14784769811725806, 'bio': 0.2838690145717053,
'pharma': 0.07212580567407506, 'auto': 0.033317365127124576, 'retail':
0.196812283035799, 'manufacturing': 0.030833323949323293\}
IR hier\_is:  22.17972270765723
IR hier\_oos:  22.014619742221665
IR equal\_is:  8.934768780668415
IR equal\_oos:  8.982252859122386

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}9}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{p}{]}
        \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{]}
        
        \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Hierarchical}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equal Weighted}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        
        \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
            \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
        
        \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
        
        \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
        \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
        \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
        \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
        
        \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
        \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
        \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. Hierarchical }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_15_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}10}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Equal / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Equal / Markowitz:  1.3139788078185306

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}11}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Markowitz:  2.8762212329272607

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}12}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Equal: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Equal:  2.1889403511022882

    \end{Verbatim}

    The in-sample Markowitz IR is way above the ground truth IR. This may
seem curious, but is explained by the overfitting to in-sample data.
Whenever we are overfitting to in-sample data we can expect the
out-of-sample performance to suffer. This phenomenon is nicely
illustrated by the abysmal out-of-sample IR. The structure imposed by
the hierarchical method causes both the in-sample and out-of-sample
performance to be much closer to the ground truth. When the number of
assets is sufficiently high, equal weighting outperforms Markowitz. The
hierarchical method can improve upon equal weighting almost always. Note
that in this context equal weighting does not imply blindly allocating
equal weights to longs and short \emph{regardless of the industry}.
Instead, it assumes that in a prior step the alpha model picked roughly
equal numbers of longs and shorts of a certain industry. This follows
since the deterministic trend \(\mu\) is sampled uniformly with mean
zero. It is more appropriately thought of as a industry-matched equal
weighting scheme.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}13}]:} \PY{c+c1}{\PYZsh{} create a portfolio object and print some method outputs}
         \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                        \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                        \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                        \PY{n}{sector\PYZus{}id}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{str}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{.}\PY{n}{values}
                       \PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sector\PYZus{}net\PYZus{}exposures: }\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{sector\PYZus{}net\PYZus{}exposures}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 450 Assets, \$59.96 Long, \$59.96 Short
largest long: banks\_stock\_45 0.9999573360418466
largest short: insurance\_stock\_40 -0.9249530915414368
sector\_net\_exposures:
            position\_value
sector\_id
aut             -0.398064
ban              0.166075
bio             -0.423796
ins             -0.594435
man              0.690644
oil             -1.106129
pha              1.326872
ret              0.459944
tec             -0.121112

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}14}]:} \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{head}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
                       position  price  factor\_value sector\_id  position\_value
banks\_stock\_45         0.999957      1           1.0       ban        0.999957
insurance\_stock\_14     0.879602      1           1.0       ins        0.879602
manufacturing\_stock\_2  0.791352      1           1.0       man        0.791352
pharma\_stock\_44        0.750419      1           1.0       pha        0.750419
insurance\_stock\_4      0.696782      1           1.0       ins        0.696782

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}15}]:} \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}15}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1bc1e438>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_22_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{principal-component-analysis}{%
\subsection{Principal Component
Analysis}\label{principal-component-analysis}}

Principal Component Analysis (PCA) allows us to reduce the rank of the
covariance matrix. Since the covariance matrix is symmetric we can
decompose the matrix into its real eigenvalues and orthonormal
eigenvectors. This follows from the spectral theorem.
\[S=Q \Lambda Q^{-1}=Q \Lambda Q^{\mathrm{T}} \quad \text { with } \quad Q^{-1}=Q^{\mathrm{T}}\]
In the simulation we have exposure to the market and several industries.
Thus it makes sense to reduce the rank to the number of these variables.
Plotting the proportion of variance explained by the first n principal
components confirms this hypothesis.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}16}]:} \PY{k+kn}{from} \PY{n+nn}{sklearn}\PY{n+nn}{.}\PY{n+nn}{decomposition} \PY{k}{import} \PY{n}{PCA} \PY{k}{as} \PY{n}{sklearnPCA}
         
         \PY{n}{n\PYZus{}components} \PY{o}{=} \PY{l+m+mi}{20}
         \PY{n}{sklearn\PYZus{}pca} \PY{o}{=} \PY{n}{sklearnPCA}\PY{p}{(}\PY{n}{n\PYZus{}components}\PY{o}{=}\PY{n}{n\PYZus{}components}\PY{p}{)}
         \PY{n}{pc} \PY{o}{=} \PY{n}{sklearn\PYZus{}pca}\PY{o}{.}\PY{n}{fit\PYZus{}transform}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{bar}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}components}\PY{p}{)}\PY{p}{,}\PY{n}{sklearn\PYZus{}pca}\PY{o}{.}\PY{n}{explained\PYZus{}variance\PYZus{}ratio\PYZus{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Variance Explained by PC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_24_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}17}]:} \PY{c+c1}{\PYZsh{} denoise covariance matrix}
         \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
         \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
         
         \PY{n}{evalues}\PY{p}{,} \PY{n}{Q} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{eig}\PY{p}{(}\PY{n}{cov}\PY{p}{)}
         \PY{n}{evalues}\PY{p}{[}\PY{n}{evalues} \PY{o}{\PYZlt{}} \PY{n}{evalues}\PY{p}{[}\PY{n}{n\PYZus{}components}\PY{p}{]}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{Q\PYZus{}T} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{matrix}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{Q}\PY{p}{)}
         \PY{n}{L} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{n}{evalues}\PY{p}{)}
         \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{Q}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{L}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Q\PYZus{}T}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{real}\PY{p}{)}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}18}]:} \PY{k+kn}{import} \PY{n+nn}{seaborn} \PY{k}{as} \PY{n+nn}{sns}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}18}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1c868ba8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_26_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}19}]:} \PY{c+c1}{\PYZsh{} plot sample covariance matrix to compare}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}19}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1c0dc898>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_27_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}20}]:} \PY{c+c1}{\PYZsh{} compute ground truth covariance matrix to compare}
         \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
         \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
         \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{cov\PYZus{}truth}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}20}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1d5a6390>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_28_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The heatmaps above look almost indistinguishable after eliminating all
other components.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}21}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industry} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                     \PY{n}{market}\PY{p}{,}
                                                                     \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                     \PY{n}{i}\PY{p}{,}
                                                                     \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                     \PY{n}{p\PYZus{}year}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground thruth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} standard sample moments}
             \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} PCA}
             \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{pc\PYZus{}cov}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{n}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{pc\PYZus{}cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is:  23.928091331371824
IR gt\_oos:  25.690924746070923

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  70.31358258914639
IR sm\_oos:  8.820658092799544
IR pca\_is:  23.02183181140094
IR pca\_oos:  24.185608362682228
MC run:  1
IR gt\_is:  23.483157047813364
IR gt\_oos:  23.201994695294516
IR sm\_is:  84.1651737323713
IR sm\_oos:  7.706546516065167
IR pca\_is:  21.41364071779635
IR pca\_oos:  21.43571944493367
MC run:  2
IR gt\_is:  22.28053644927649
IR gt\_oos:  23.381364215926908
IR sm\_is:  77.93833732468957
IR sm\_oos:  7.749301682353445
IR pca\_is:  21.432762259498002
IR pca\_oos:  21.81894849118108
MC run:  3
IR gt\_is:  23.455531871051292
IR gt\_oos:  24.01300349901305
IR sm\_is:  65.42997462402077
IR sm\_oos:  7.6775763122535405
IR pca\_is:  23.021110673153178
IR pca\_oos:  22.849885724873147
MC run:  4
IR gt\_is:  24.184545118553274
IR gt\_oos:  24.30887580550335
IR sm\_is:  69.11615485823607
IR sm\_oos:  10.487583844591857
IR pca\_is:  22.93057948612109
IR pca\_oos:  23.17622141063133
MC run:  5
IR gt\_is:  26.414787971437303
IR gt\_oos:  22.95311175767001
IR sm\_is:  76.88479408716702
IR sm\_oos:  8.81001811360005
IR pca\_is:  24.65964285823324
IR pca\_oos:  21.08724797685001
MC run:  6
IR gt\_is:  23.117734276665452
IR gt\_oos:  24.539536043691076
IR sm\_is:  65.50914915015383
IR sm\_oos:  7.497741821965262
IR pca\_is:  21.859366534100225
IR pca\_oos:  22.482987575194088
MC run:  7
IR gt\_is:  22.488948436840026
IR gt\_oos:  22.576062710794744
IR sm\_is:  75.00567964723727
IR sm\_oos:  6.4545595153664825
IR pca\_is:  21.597449811693807
IR pca\_oos:  21.12812007140757
MC run:  8
IR gt\_is:  21.87509337251639
IR gt\_oos:  24.458493756190276
IR sm\_is:  64.5012049016925
IR sm\_oos:  8.950179482518198
IR pca\_is:  20.792584629494716
IR pca\_oos:  22.675317968867915
MC run:  9
IR gt\_is:  22.947254544337085
IR gt\_oos:  23.545244952815107
IR sm\_is:  76.48684538500122
IR sm\_oos:  6.737335116130717
IR pca\_is:  21.517691968484655
IR pca\_oos:  21.664761442031843

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}22}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PCA}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. PCA }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_31_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}23}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS PCA / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS PCA / Markowitz:  2.750657573413819

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}24}]:} \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{cov}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
450
11

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}25}]:} \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                        \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                        \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                        \PY{n}{sector\PYZus{}id}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{str}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sector\PYZus{}net\PYZus{}exposures:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{sector\PYZus{}net\PYZus{}exposures}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 450 Assets, \$131.33 Long, \$131.33 Short
largest long: bio\_stock\_18 0.8707197141374607
largest short: bio\_stock\_10 -0.8608912496009911
sector\_net\_exposures:
            position\_value
sector\_id
aut              0.409164
ban             -1.761326
bio              2.450520
ins              0.550541
man             -1.168924
oil             -1.701275
pha              0.933427
ret              2.341407
tec             -2.053537

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}26}]:} \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}26}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1b76bbe0>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_35_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    PCA reduced extreme positions and set a lot fewer weights close to zero.

    \hypertarget{robustness-under-fat-tailed-noise-distribution}{%
\subsection{Robustness under fat-tailed noise
distribution}\label{robustness-under-fat-tailed-noise-distribution}}

The Generalized Autoregressive Conditional Heteroskedasticity (GARCH)
model is defined by:

\(\begin{aligned} r_{t} &=\mu_{t}+\epsilon_{t} \\ \epsilon_{t} &=\sigma_{t} \eta_{t}, \quad \eta_{t} \stackrel{i i d}{\sim}(0,1) \\ \sigma_{t}^{2} &=\omega+\sum_{i=1}^{q} \alpha_{i} \epsilon_{t-i}^{2}+\sum_{i=1}^{p} \beta_{i} \sigma_{t-i}^{2} \\ \omega &>0, \quad \alpha_{i} \geq 0, \quad i=1, \ldots, q, \quad \beta_{i} \geq 0, \quad i=1, \ldots, p \end{aligned}\)

The unconditional variance becomes:

\(\begin{aligned} \mathrm{E}\left(\sigma_{t}^{2}\right) &=\omega+\sum_{i=1}^{q} \alpha_{i} \mathrm{E}\left(\epsilon_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\sum_{i=1}^{q} \alpha_{i} \mathrm{E}\left(\eta_{t-i}^{2} \sigma_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\sum_{i=1}^{q} \alpha_{i} \underbrace{\mathrm{E}\left(\eta_{t-i}^{2}\right)}_{=1} \mathrm{E}\left(\sigma_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\left(\sum_{i=1}^{q} \alpha_{i}+\sum_{i=1}^{p} \beta_{i}\right) \mathrm{E}\left(\sigma_{t}^{2}\right) \end{aligned}\)

\(\begin{array}{l}{\text { Solving for } \mathrm{E}\left(\sigma_{t}^{2}\right), \text { we have the unconditional variance }} \\ {\qquad \begin{aligned} \mathrm{E}\left(\epsilon_{t}^{2}\right) &=\mathrm{E}\left(\sigma_{t}^{2}\right) \\ &=\frac{\omega}{1-\sum_{i=1}^{q} \alpha_{i}-\sum_{i=1}^{p} \beta_{i}} \end{aligned}}\end{array}\)

Equity curves under this noise distribution look like this.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}27}]:} \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         \PY{n}{banks} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         \PY{n}{stocks}\PY{p}{,} \PY{o}{*}\PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{banks}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                                       \PY{n}{sigma\PYZus{}noise}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{p}{,} \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                       \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{)}
         \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_38_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    As you can see, returns are much more extreme than under Gaussian noise.

First let's compare Markowitz vs.~hierachrichal vs.~equal weighting
under a GARCH(1,1) noise distribution.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}28}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                           \PY{n}{market}\PY{p}{,}
                                                                           \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                           \PY{n}{i}\PY{p}{,}
                                                                           \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                           \PY{n}{p\PYZus{}year}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}alpha}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}beta}\PY{p}{)}
         
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
                 \PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                              \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                              \PY{k+kc}{True}\PY{p}{,}
                                              \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                              \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
         \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                              \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
                 \PY{n}{industries\PYZus{}portfolio}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                                  \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground truth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} GARCH uncond Var}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{p}{(}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}alpha}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}beta}\PY{p}{)}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{}standard sample moments}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,}
                                                  \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} hierarchical}
             \PY{c+c1}{\PYZsh{} optimize allocation to industry}
             \PY{n}{industry\PYZus{}weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                          \PY{k+kc}{False}\PY{p}{,}
                                                          \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{index}\PY{o}{=}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{data}\PY{o}{=}\PY{p}{[}\PY{l+m+mf}{0.1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
         \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{p}{,}
                                                          \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}     \PYZsh{} equal weighting industries}
         \PY{c+c1}{\PYZsh{}     for i in industry\PYZus{}weights.keys():}
         \PY{c+c1}{\PYZsh{}         industry\PYZus{}weights[i] = 1/len(industries)}
         
             \PY{n+nb}{print}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
         
             \PY{c+c1}{\PYZsh{} Make same gross leverage}
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} Make same gross leverage}
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}equal} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{equal\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is:  11.381839784897373
IR gt\_oos:  10.25005811476404

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  36.63963061230803
IR sm\_oos:  4.447973650722289
\{'banks': 0.05778225231788303, 'oil': 0.10428342897861984, 'insurance':
0.07543521741571599, 'tech': 0.31587014916029615, 'bio': 0.050455000852612675,
'pharma': 0.15935180704660465, 'auto': 0.04333117964647641, 'retail':
0.18252817857797649, 'manufacturing': 0.010962786003814857\}
IR hier\_is:  11.198458124852193
IR hier\_oos:  8.235602345763404
IR equal\_is:  7.580915620590376
IR equal\_oos:  6.703342353268531
MC run:  1
IR gt\_is:  9.427480157674227
IR gt\_oos:  12.04492945891945
IR sm\_is:  27.499891349533453
IR sm\_oos:  4.447499004304111
\{'banks': 0.06433997473727043, 'oil': 0.05918855736535658, 'insurance':
0.053130060258645535, 'tech': 0.32265337949361256, 'bio': 0.07564121246094861,
'pharma': 0.19243461205111537, 'auto': 0.0835758149828067, 'retail':
0.10935979291778583, 'manufacturing': 0.03967659573245841\}
IR hier\_is:  9.347236155451956
IR hier\_oos:  10.332460710116338
IR equal\_is:  6.045709074937399
IR equal\_oos:  6.950190038983944
MC run:  2
IR gt\_is:  11.495035744085095
IR gt\_oos:  10.326510454283552
IR sm\_is:  37.81650733172764
IR sm\_oos:  4.6807904980900155
\{'banks': 0.12907389111307793, 'oil': 0.11710363764998055, 'insurance':
0.09084238467002748, 'tech': 0.1749535621009709, 'bio': 0.06683672435545432, 'pharma':
0.24160239479144172, 'auto': 0.05556876003657864, 'retail': 0.04552629225782874,
'manufacturing': 0.07849235302463957\}
IR hier\_is:  12.783302981964487
IR hier\_oos:  9.905665791267666
IR equal\_is:  6.3807942867290315
IR equal\_oos:  5.414102910618966
MC run:  3
IR gt\_is:  11.17564352096621
IR gt\_oos:  9.213171446595831
IR sm\_is:  43.32939425983168
IR sm\_oos:  3.3037538831891653
\{'banks': 0.02680541279426938, 'oil': 0.06408584330920583, 'insurance':
0.07067009006568603, 'tech': 0.08334107671773831, 'bio': 0.01666844778347558,
'pharma': 0.3354506367659482, 'auto': 0.0719435939908445, 'retail':
0.2408071285866011, 'manufacturing': 0.09022776998623104\}
IR hier\_is:  10.495916818712914
IR hier\_oos:  8.243207986145178
IR equal\_is:  7.139216341552791
IR equal\_oos:  6.162957550168578
MC run:  4
IR gt\_is:  11.01799937180968
IR gt\_oos:  11.822311610672777
IR sm\_is:  43.929621234522926
IR sm\_oos:  4.374620503352312
\{'banks': 0.08166488979222801, 'oil': 0.021013901560859975, 'insurance':
0.03401438499587243, 'tech': 0.07556887845240953, 'bio': 0.1018213957840598, 'pharma':
0.4733388205338499, 'auto': 0.06013865550315474, 'retail': 0.11102671202606172,
'manufacturing': 0.0414123613515039\}
IR hier\_is:  10.472858271545643
IR hier\_oos:  10.073861982124532
IR equal\_is:  5.99842921746639
IR equal\_oos:  7.3294468896598834
MC run:  5
IR gt\_is:  10.103824220304778
IR gt\_oos:  11.421185324211141
IR sm\_is:  34.55518539676023
IR sm\_oos:  3.1879457577902666
\{'banks': 0.08970815066948956, 'oil': 0.1307340776803956, 'insurance':
0.12469407189883207, 'tech': 0.24073645540833558, 'bio': 0.056126806518994134,
'pharma': 0.2154506599583787, 'auto': 0.04356796923998072, 'retail':
0.03811312527453183, 'manufacturing': 0.06086868335106177\}
IR hier\_is:  10.960718037258717
IR hier\_oos:  9.97486228127692
IR equal\_is:  8.092429722249209
IR equal\_oos:  8.679285237881217
MC run:  6
IR gt\_is:  10.29488944780034
IR gt\_oos:  12.17669296205728
IR sm\_is:  23.096866138190084
IR sm\_oos:  3.5244099446923105
\{'banks': 0.04458821663588455, 'oil': 0.1452822330941247, 'insurance':
0.054715831023717125, 'tech': 0.34155364901948704, 'bio': 0.09827721046719719,
'pharma': 0.11610843429365972, 'auto': 0.09071148619784236, 'retail':
0.04016316521994309, 'manufacturing': 0.06859977404814413\}
IR hier\_is:  10.497003057044049
IR hier\_oos:  9.692562797952181
IR equal\_is:  5.647853461730689
IR equal\_oos:  7.372422037737031
MC run:  7
IR gt\_is:  11.35421453018477
IR gt\_oos:  11.050013757617139
IR sm\_is:  34.609865179971735
IR sm\_oos:  3.2509384370362224
\{'banks': 0.05269538627612803, 'oil': 0.042157948864162915, 'insurance':
0.10730678314860663, 'tech': 0.1836807118111258, 'bio': 0.15576599512650935, 'pharma':
0.22809336008536024, 'auto': 0.07670383721407253, 'retail': 0.06291820784434829,
'manufacturing': 0.09067776962968625\}
IR hier\_is:  12.545979633101311
IR hier\_oos:  9.466487040454792
IR equal\_is:  6.949506583531387
IR equal\_oos:  6.114972061598138
MC run:  8
IR gt\_is:  10.353999316140763
IR gt\_oos:  10.61824714848229
IR sm\_is:  37.48072170328032
IR sm\_oos:  2.252356765823739
\{'banks': 0.07809976100716372, 'oil': 0.05241842869191247, 'insurance':
0.12488063623068338, 'tech': 0.08794854357363897, 'bio': 0.04402867182081638,
'pharma': 0.43712944433692213, 'auto': 0.06101065552288361, 'retail':
0.07928380223493628, 'manufacturing': 0.0352000565810431\}
IR hier\_is:  10.767989311510496
IR hier\_oos:  8.897603816122166
IR equal\_is:  5.409423410205528
IR equal\_oos:  5.950879525394032
MC run:  9
IR gt\_is:  12.14637426022587
IR gt\_oos:  10.761432374181734
IR sm\_is:  36.26266064003784
IR sm\_oos:  2.8696040212229548
\{'banks': 0.04234865653226834, 'oil': 0.045858654229409344, 'insurance':
0.05138479316066373, 'tech': 0.40415831548117837, 'bio': 0.01833294734327381,
'pharma': 0.07967726146882839, 'auto': 0.08538397693076907, 'retail':
0.1305072636491138, 'manufacturing': 0.1423481312044952\}
IR hier\_is:  11.846574846619799
IR hier\_oos:  8.819680650273495
IR equal\_is:  7.919171428328404
IR equal\_oos:  6.9260644655664425

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}29}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Hierarchical}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equal Weighted}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. Hierarchical }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_41_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}30}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Markowitz:  2.576837438045077

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}31}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Equal / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Equal / Markowitz:  1.8603154407711007

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}32}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Equal: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Equal:  1.38516156000779

    \end{Verbatim}

    Under fat-tails Markowitz performs even worse since extreme positions
expose the portfolio to asset specific tail risk. In particular,
Markowitz underperforms equal weighting significantly. The hierarchical
method still outperforms equal weighting, though.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}33}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                           \PY{n}{market}\PY{p}{,}
                                                                           \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                           \PY{n}{i}\PY{p}{,}
                                                                           \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                           \PY{n}{p\PYZus{}year}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}alpha}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}beta}
                                                                           \PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground truth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} GARCH uncond Var}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{p}{(}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}alpha}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}beta}\PY{p}{)}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} standard sample moments}
             \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} PCA}
             \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{pc\PYZus{}cov}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{n}\PY{p}{)}
         
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{pc\PYZus{}cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is 10.261467730615779
IR gt\_oos 12.205307170065185

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  31.20512771358549
IR sm\_oos:  3.8123236510782195
IR pca\_is:  10.01501451645455
IR pca\_oos:  11.31193298615081
MC run:  1
IR gt\_is 10.834829073114502
IR gt\_oos 10.199363654522566
IR sm\_is:  48.5033767861998
IR sm\_oos:  2.587504099906182
IR pca\_is:  11.221432505644566
IR pca\_oos:  9.415137484914569
MC run:  2
IR gt\_is 11.350257499414049
IR gt\_oos 11.37098932637587
IR sm\_is:  34.63852875817028
IR sm\_oos:  4.376452464663717
IR pca\_is:  11.529198106561122
IR pca\_oos:  10.268443128966922
MC run:  3
IR gt\_is 10.656830170999497
IR gt\_oos 10.167979939837414
IR sm\_is:  28.915355118058606
IR sm\_oos:  3.8330860405686034
IR pca\_is:  10.166715341968379
IR pca\_oos:  9.737725994879051
MC run:  4
IR gt\_is 11.346637358483017
IR gt\_oos 11.631193482210865
IR sm\_is:  13.434900789513023
IR sm\_oos:  2.824394471191307
IR pca\_is:  11.2701557116966
IR pca\_oos:  11.051427591477806
MC run:  5
IR gt\_is 10.972648077846118
IR gt\_oos 12.07679547454538
IR sm\_is:  45.755145658179934
IR sm\_oos:  3.663931866736201
IR pca\_is:  10.436667076113618
IR pca\_oos:  11.144498371271428
MC run:  6
IR gt\_is 10.68026508950257
IR gt\_oos 11.684912698906743
IR sm\_is:  21.14543558335082
IR sm\_oos:  2.737664908310083
IR pca\_is:  10.33723606638786
IR pca\_oos:  10.585595086766487
MC run:  7
IR gt\_is 10.805406472099559
IR gt\_oos 10.74162797359147
IR sm\_is:  31.122845181605665
IR sm\_oos:  4.150300717750667
IR pca\_is:  9.91937434019101
IR pca\_oos:  10.415509985218758
MC run:  8
IR gt\_is 8.839536302610709
IR gt\_oos 12.194076158622874
IR sm\_is:  23.73105172327393
IR sm\_oos:  5.663203864980169
IR pca\_is:  9.035793751477094
IR pca\_oos:  11.744754327636812
MC run:  9
IR gt\_is 11.779771362516906
IR gt\_oos 11.270879177584115
IR sm\_is:  23.736621133458673
IR sm\_oos:  4.873290937938001
IR pca\_is:  10.523662012346414
IR pca\_oos:  10.206854599638687

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}34}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS PCA / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS PCA / Markowitz:  2.7485971382068155

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}35}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PCA}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. PCA }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.5\linewidth}{0.5\paperheight}}{demo_files/demo_48_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The PCA method, too, outperforms Markowitz by a large margin under
fat-tails.

    \hypertarget{conclusion}{%
\subsection{Conclusion}\label{conclusion}}

Industry-neutral equal weighting can go a long way. If the number of
assets is large, it tends to outperform mean-variance optimization based
on sample moments. It certainly is better than long-only portfolio
construction. If one is willing to invest the effort to go beyond naive
approaches, imposing structure by hierarchical methods, shrinkage
estimation or noise reduction via PCA seem to be good approaches based
on Monte Carlo evidence. In addition, I showed that these methods are
robust to asset-specific fat-tailed noise by having fewer extreme and
instead more numerous moderate position weights.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor} }]:} 
\end{Verbatim}


    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
