
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    \usepackage{mathrsfs}
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}
    \definecolor{ansi-default-inverse-fg}{HTML}{FFFFFF}
    \definecolor{ansi-default-inverse-bg}{HTML}{000000}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatibility definitions
    \def\gt{>}
    \def\lt{<}
    \let\Oldtex\TeX
    \let\Oldlatex\LaTeX
    \renewcommand{\TeX}{\textrm{\Oldtex}}
    \renewcommand{\LaTeX}{\textrm{\Oldlatex}}
    % Document parameters
    % Document title
    \title{Understanding Portfolio Optimization by Simulation}
    \author{Jan Philipp WÃ¶ltjen}
    
    
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \hypertarget{portfolio-optimization}{%
\section{Portfolio Optimization}\label{portfolio-optimization}}

    In the following I will investigate several portfolio optimization
methods by means of Monte Carlo simulation. In particular, I will
compare Markowitz mean-variance optimization based on sample moments
with industry-neutral equal weighting as a baseline. Further, I will
explore a hierarchical method and principal component analysis as a
means to reduce estimation error of the covariance matrix. These methods
can improve upon Markowitz optimization and equal weighting both under
Gaussian and fat-tailed noise distributions.

Let's simulate a bunch of stocks belonging to different industries. Each
stock is composed of a deterministic trend \(\mu\), a loading on the
market related stochastic trend \(\beta_{market}\) and a loading on the
industry specific stochastic trend \(\beta_{industry}\). For each stock,
\(\mu\), \(\beta_{market}\), and \(\beta_{industry}\) are sampled from a
uniform distribution. In the first simulation, I compare a mean-variance
optimization with a naive diversification approach where each asset is
equally weighted with the sign of the expected value. At this point I
should emphasize that I assume perfect knowledge of the expected value.
Traditionally, the expected value is estimated by the in-sample first
moment of the asset. In my example, this would actually make sense since
the mean is a consistent estimator of the deterministic trend. In
practice, however, there is probably not a constant deterministic trend.
This is where the alpha model steps in, which is not the topic of this
study and thus assumed given.

The return of each stock is thus given by

\[\begin{aligned} R_{i t} &=\mu_{i}+\beta_{i 1} f_{1 t}+\beta_{i 2} f_{2 t}+\cdots+\beta_{i k} f_{k t}+\epsilon_{i t} \\ &=\mu_{i}+\sum_{\ell=1}^{k} \beta_{i \ell} f_{\ell t}+\epsilon_{i t}, \quad i=1, \ldots, N, \quad t=1, \ldots, T. \end{aligned}\]

\(\begin{array}{l}{R_{i t} \text { is the return of asset } i \text { at time } t, i=1, \ldots, N} \\ {f_{\ell t} \text { is the } \ell \text { th common factor at time } t, \ell=1, \ldots, k} \\ {\beta_{i \ell} \text { is the factor loading or factor beta of asset } i \text { with respect to factor }} \\ {\ell, i=1, \ldots, N, \ell=1, \ldots, k} \\ {\epsilon_{i t} \text { is the asset-specific factor or asset-specific risk. }}\end{array}\)

\(\begin{array}{l}{\text { The } k \times k \text { covariance matrix of the factors is }} \\ {\qquad \operatorname{Cov}\left(\boldsymbol{f}_{t}\right)=\boldsymbol{\Sigma}_{f},} \\ {\text { where }} \\ {\qquad \boldsymbol{f}_{t}=\left[f_{1 t}, f_{2 t}, \ldots, f_{k t}\right]^{\prime}.}\end{array}\)

\(\text {Asset-specific noise is uncorrelated with the factors } \operatorname{Cov}\left(f_{\ell t}, \epsilon_{i t}\right)=0, \quad \ell=1, \ldots, k, \quad i=1, \ldots, N, \quad t=1, \ldots, T\),

\(\begin{array}{l}{\text { The asset-specific risks are likewise uncorrelated across assets, and for }} \\ {\text { each asset they are serially uncorrelated, }} \\ {\qquad \operatorname{Cov}\left(\epsilon_{i t}, \epsilon_{j t^{\prime}}\right)=\left\{\begin{array}{ll}{\sigma_{i}^{2}} & {\text { if } i=j \text { and } t=t^{\prime}} \\ {0} & {\text { otherwise }}\end{array}\right.}\end{array},\)

\(\boldsymbol{\Sigma}_{\boldsymbol{\epsilon}}=\operatorname{Cov}\left(\boldsymbol{\epsilon}_{t}\right)=\left[\begin{array}{cccc}{\sigma_{\epsilon_{1}}^{2}} & {0} & {\cdots} & {0} \\ {0} & {\sigma_{\epsilon_{2}}^{2}} & {\cdots} & {0} \\ {\vdots} & {\vdots} & {\ddots} & {\vdots} \\ {0} & {0} & {\cdots} & {\sigma_{\epsilon_{N}}^{2}}\end{array}\right]=\operatorname{diag}\left(\sigma_{\epsilon_{1}}^{2}, \sigma_{\epsilon_{2}}^{2}, \ldots, \sigma_{\epsilon_{N}}^{2}\right).\)

Thus a diagonal covariance structure reflects the assumption that all
correlation between assets is due to the factors.

\(\begin{array}{l}{\text { If we write the factor model as }} \\ {\qquad \boldsymbol{R}_{t}=\boldsymbol{\alpha}+\boldsymbol{B} \boldsymbol{f}_{t}+\boldsymbol{\epsilon}_{t}, \quad t=1, \ldots, T}\end{array}\)

\(\begin{array}{l}{\text { where in the } N \times k \text { matrix }} \\ {\qquad B=\left[\begin{array}{c}{\boldsymbol{\beta}_{1}^{\prime}} \\ {\boldsymbol{\beta}_{2}^{\prime}} \\ {\vdots} \\ {\boldsymbol{\beta}_{N}^{\prime}}\end{array}\right]=\left[\begin{array}{cccc}{\beta_{11}} & {\beta_{12}} & {\cdots} & {\beta_{1 k}} \\ {\beta_{21}} & {\beta_{22}} & {\cdots} & {\beta_{2 k}} \\ {\vdots} & {\vdots} & {\ddots} & {\vdots} \\ {\beta_{N 1}} & {\beta_{N 2}} & {\cdots} & {\beta_{N k}}\end{array}\right]} \\ {\text { the }} \ell {\text {th column contains the beta coefficients associated with factor } \ell}\end{array}\)

\(\begin{array}{l}{\text { The covariance matrix of the returns } R_{t}=\left[R_{1 t}, R_{2 t}, \ldots, R_{N t}\right] \text { implied }} \\ {\text { by the factor model is }} \\ {\qquad \Sigma=\operatorname{Cov}\left(R_{t}\right)=B \Sigma_{f} B^{\prime}+\Sigma_{\epsilon}}\end{array}\)

\(\begin{array}{l}{\text { That is, }} \\ {\qquad \begin{aligned} \operatorname{Var}\left(R_{i}\right) &=\beta_{i}^{\prime} \Sigma_{f} \beta_{i}+\sigma_{\epsilon_{i}}^{2} \\ \operatorname{Cov}\left(R_{i}, R_{j}\right) &=\beta_{i}^{\prime} \Sigma_{f} \beta_{j} \end{aligned}}\end{array}\)

\(\begin{array}{l}{\text { Since the factors are uncorrelated in this simulation, the covariance matrix }\text { simplifies to}} \\ {\qquad \Sigma=B \Sigma_{f} B^{\prime}+\Sigma_{\epsilon}=\sum_{\ell=1}^{k} \beta_{\ell} \beta_{\ell}^{\prime} e_{f_{\ell}}^{2}+\Sigma_{\epsilon}}\end{array}\)

\(\begin{array}{l}{\text { where }} \\ {\beta_{\ell} \text { is the vector of loadings with respect to factor } \ell, \text { i.e. the } \ell \text { th column }} \\ {\text { of matrix } \boldsymbol{B} \text { , }} \\ {\sigma_{f_{\ell}}^{2} \text { is the variance of factor } \ell}\end{array}\)

\(\text { Thus the variance of asset } i \text { is }\)
\[\sigma_{i}^{2}=\sum_{\ell=1}^{k} \beta_{i \ell}^{2} \sigma_{f_{\ell}}^{2}+\sigma_{\epsilon_{i}}^{2} \]

\(\text { and the covariance between the returns of assets } i \text { and } j \text { is }\)
\[ \sigma_{i j}=\sum_{\ell=1}^{k} \beta_{i \ell} \beta_{j \ell} \sigma_{f_{\ell}}^{2}\]

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}3}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{k+kn}{import} \PY{n+nn}{pandas} \PY{k}{as} \PY{n+nn}{pd}
        \PY{k+kn}{from} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{linalg} \PY{k}{import} \PY{n}{eigh}\PY{p}{,} \PY{n}{cholesky}
        \PY{k+kn}{from} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{stats} \PY{k}{import} \PY{n}{norm}
        \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{pyplot} \PY{k}{as} \PY{n}{plt}
        \PY{n}{plt}\PY{o}{.}\PY{n}{style}\PY{o}{.}\PY{n}{use}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seaborn}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} \PYZpc{}matplotlib notebook}
        \PY{k+kn}{from} \PY{n+nn}{src} \PY{k}{import} \PY{n}{optimize}
        \PY{k+kn}{from} \PY{n+nn}{src}\PY{n+nn}{.}\PY{n+nn}{portfolio} \PY{k}{import} \PY{n}{Portfolio}
        
        
        \PY{k}{def} \PY{n+nf}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{industry\PYZus{}name}\PY{p}{,} \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{)}\PY{p}{:}
            \PY{n}{mu} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{n}{p\PYZus{}year}
            \PY{n}{beta\PYZus{}market} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{stocks} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
        
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{:}
                \PY{n}{normal\PYZus{}noise} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma\PYZus{}noise}
                \PY{n}{stocks}\PY{p}{[}\PY{n}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+si}{\PYZob{}industry\PYZus{}name\PYZcb{}}\PY{l+s+s1}{\PYZus{}stock\PYZus{}}\PY{l+s+si}{\PYZob{}i\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{mu}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{market} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{industry} \PY{o}{+}
                                                        \PY{n}{normal\PYZus{}noise}\PY{p}{)}
            \PY{n}{mu}\PY{o}{.}\PY{n}{index} \PY{o}{=} \PY{n}{stocks}\PY{o}{.}\PY{n}{columns}
            \PY{k}{return} \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry}
        
        
        \PY{k}{def} \PY{n+nf}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{sigma\PYZus{}sq\PYZus{}0}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{alpha}\PY{p}{,} \PY{n}{beta}\PY{p}{,} \PY{n}{omega}\PY{p}{)}\PY{p}{:}
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{} generate GARCH log returns \PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{nu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{normal}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{n}{n}\PY{p}{)}
            \PY{n}{r} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{epsilon} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{sigma\PYZus{}sq} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{sigma\PYZus{}sq\PYZus{}0}
        
            \PY{k}{if} \PY{n+nb}{min}\PY{p}{(}\PY{n}{alpha}\PY{p}{,} \PY{n}{beta}\PY{p}{)} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{:}
                \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{alpha, beta need to be non\PYZhy{}negative}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{k}{if} \PY{n}{omega} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{l+m+mi}{0}\PY{p}{:}
                \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{omega needs to be positive}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{alpha}\PY{o}{+}\PY{n}{beta} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{1}\PY{p}{:}
                \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{alpha+beta\PYZgt{}=1, variance not defined \PYZhy{}\PYZhy{}\PYZgt{}}\PY{l+s+se}{\PYZbs{}}
        \PY{l+s+s1}{              time series will not be weakly stationary}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n}\PY{p}{)}\PY{p}{:}
        
                \PY{k}{if} \PY{n}{i} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
                    \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{omega} \PY{o}{+}
                                   \PY{n}{alpha} \PY{o}{*} \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+}
                                   \PY{n}{beta} \PY{o}{*} \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        
                \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)} \PY{o}{*} \PY{n}{nu}\PY{p}{[}\PY{n}{i}\PY{p}{]}
        
                \PY{n}{r}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{mu} \PY{o}{+} \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{p}{]}
            \PY{k}{return} \PY{n}{r}
        
        
        \PY{k}{def} \PY{n+nf}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{industry\PYZus{}name}\PY{p}{,}
                                      \PY{n}{sigma\PYZus{}noise}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{,} \PY{n}{garch\PYZus{}mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,}
                                      \PY{n}{garch\PYZus{}alpha}\PY{o}{=}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{o}{=}\PY{l+m+mf}{0.4}\PY{p}{)}\PY{p}{:}
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{} Generate stocks of given industry with fat\PYZhy{}tailed noise. \PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{mu} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{n}{p\PYZus{}year}
            \PY{n}{beta\PYZus{}market} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{stocks} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
            \PY{n}{garch\PYZus{}noise} \PY{o}{=} \PY{n}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                               \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,}
                                               \PY{n}{garch\PYZus{}mu}\PY{p}{,} \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{,}
                                               \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{:}
                \PY{n}{garch\PYZus{}noise} \PY{o}{=} \PY{n}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                                   \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,}
                                                   \PY{n}{garch\PYZus{}mu}\PY{p}{,} \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{,}
                                                   \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
        
                \PY{n}{stocks}\PY{p}{[}\PY{n}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+si}{\PYZob{}industry\PYZus{}name\PYZcb{}}\PY{l+s+s1}{\PYZus{}stock\PYZus{}}\PY{l+s+si}{\PYZob{}i\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{mu}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{market} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{industry} \PY{o}{+}
                                                        \PY{n}{garch\PYZus{}noise}\PY{p}{)}
            \PY{n}{mu}\PY{o}{.}\PY{n}{index} \PY{o}{=} \PY{n}{stocks}\PY{o}{.}\PY{n}{columns}
            \PY{k}{return} \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry}
        
        
        \PY{k}{def} \PY{n+nf}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{equity\PYZus{}curve}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{)}\PY{p}{:}
            \PY{k}{return} \PY{n}{equity\PYZus{}curve}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{)}\PY{o}{/}\PY{n}{equity\PYZus{}curve}\PY{o}{.}\PY{n}{std}\PY{p}{(}\PY{p}{)}\PY{o}{*}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        
        \PY{k}{def} \PY{n+nf}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{log\PYZus{}returns}\PY{p}{)}\PY{p}{:}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{exp}\PY{p}{(}\PY{n}{log\PYZus{}returns}\PY{o}{.}\PY{n}{cumsum}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{alpha}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equity Curve}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Period}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equity Value}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
        
        
        \PY{k}{def} \PY{n+nf}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{long\PYZus{}only}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{:}
            \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
            \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
            \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        
            \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}
                \PY{n}{n\PYZus{}stocks}\PY{p}{,}
                \PY{n}{market}\PY{p}{,}
                \PY{n+nb}{list}\PY{p}{(}\PY{n}{industry}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                \PY{n+nb}{list}\PY{p}{(}\PY{n}{industry}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                \PY{n}{p\PYZus{}year}\PY{p}{)}
        
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{long\PYZus{}only}\PY{p}{:}
                \PY{n}{lower\PYZus{}bound} \PY{o}{=} \PY{l+m+mi}{0}
                \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{mu}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{k}{lambda} \PY{n}{x}\PY{p}{:} \PY{l+m+mi}{0} \PY{k}{if} \PY{n}{x} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{l+m+mi}{0} \PY{k}{else} \PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{n}{mu}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                \PY{n}{market\PYZus{}neutral} \PY{o}{=} \PY{k+kc}{False}
            \PY{k}{else}\PY{p}{:}
                \PY{n}{lower\PYZus{}bound} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
                \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{mu}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{mu}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                \PY{n}{market\PYZus{}neutral} \PY{o}{=} \PY{k+kc}{True}
        
            \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{mu}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{n}{market\PYZus{}neutral}\PY{p}{,}
                                                  \PY{p}{(}\PY{n}{lower\PYZus{}bound}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{mu}\PY{p}{,} \PY{n}{stocks}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} Make same gross leverage}
            \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,} \PY{n}{equal\PYZus{}weights}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,} \PY{n}{equal\PYZus{}weights}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
        
            \PY{k}{return} \PY{n}{weights}
        
        
        
        \PY{n}{p\PYZus{}year} \PY{o}{=} \PY{l+m+mi}{250}
        \PY{n}{num\PYZus{}samples} \PY{o}{=} \PY{n}{p\PYZus{}year}\PY{o}{*}\PY{l+m+mi}{4}
        
        \PY{n}{sigma} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.14}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.07}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.2}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.12}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.22}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.05}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.125}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        \PY{n}{sigma\PYZus{}noise} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        \PY{n}{MC\PYZus{}RUNS} \PY{o}{=} \PY{l+m+mi}{10}
        \PY{n}{PLOT\PYZus{}STOCKS} \PY{o}{=} \PY{k+kc}{True}
\end{Verbatim}

    The results below show that out-of-sample (oos) performance of the
optimized portfolio using sample moments (sm) is decent if the number of
assets is relatively small and there is only one industry. It definitely
beats equal weighting (equal).

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}65}]:} \PY{n}{industry} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         \PY{n}{industry}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_4_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  11.781615280191222

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_4_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  7.308332949721227

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_4_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  12.294645503589331

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_4_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  7.308332949721227

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_4_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    As shown below, long-only performance, of course, is horrendous. This is
due to the fact that we cannot diversify the systematic risk. Since we
cannot short, hedging out that risk is also not possible. Hence, our
bets are not independent and the Law of Large Numbers does not apply.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}67}]:} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{,} \PY{n}{long\PYZus{}only}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_6_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  2.159732583044145

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_6_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  1.570613035352226

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_6_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  1.856914588723952

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_6_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  1.570613035352226

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_6_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Standard mean-variance optimization works well if the number of assets
is relatively small. When the number of assets is relatively large,
however, the out-of-sample performance is significantly worse than the
in-sample performance as demonstrated by the information ratio (IR).
Even the very naive approach of equal weighting beats mean-variance
optimization out-of-sample embarrassingly often.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}68}]:} \PY{n}{weights} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{300}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_8_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  35.54196901119124

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_8_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  13.894520897023506

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_8_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  12.450661665788113

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_8_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  13.894520897023506

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_8_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}69}]:} \PY{c+c1}{\PYZsh{} creating portfolio object}
         \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                        \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                        \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 300 Assets, \$28.37 Long, \$28.37 Short
largest long: manufacturing\_stock\_24 0.7335872080882955
largest short: manufacturing\_stock\_221 -0.675822795422206

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}70}]:} \PY{c+c1}{\PYZsh{} Showing the first 5 positions in portfolio}
         \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{head}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}70}]:}                          position  price  factor\_value  sector\_id  \textbackslash{}
         manufacturing\_stock\_24   0.733587      1           1.0        0.0   
         manufacturing\_stock\_139  0.661467      1           1.0        0.0   
         manufacturing\_stock\_210  0.487374      1           1.0        0.0   
         manufacturing\_stock\_281  0.474867      1           1.0        0.0   
         manufacturing\_stock\_40   0.473963      1           1.0        0.0   
         
                                  position\_value  
         manufacturing\_stock\_24         0.733587  
         manufacturing\_stock\_139        0.661467  
         manufacturing\_stock\_210        0.487374  
         manufacturing\_stock\_281        0.474867  
         manufacturing\_stock\_40         0.473963  
\end{Verbatim}
            
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}71}]:} \PY{c+c1}{\PYZsh{} Plotting the weight distribution}
         \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Position Allocation}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ordered Positions}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Weight}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_11_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{imposing-structure}{%
\subsection{Imposing Structure}\label{imposing-structure}}

To reduce Error Maximization we need to impose structure. One way to do
this is by using our knowledge that stocks usually cluster (e.g., into
certain industries). It seems like a good idea to encode this prior
knowledge by mean-variance optimize stocks within clusters and then
optimize allocation to these clusters. This is pursued next and compared
to the standard optimization.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}72}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                     \PY{n}{market}\PY{p}{,}
                                                                     \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                     \PY{n}{i}\PY{p}{,}
                                                                     \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                     \PY{n}{p\PYZus{}year}\PY{p}{)}
         
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,} \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
                 \PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}
                      \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                      \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                      \PY{k+kc}{True}\PY{p}{,}
                      \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                      \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                      \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
                 \PY{n}{industries\PYZus{}portfolio}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}
                     \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
         
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground thruth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} standard sample moments}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,}
                                                   \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} hierarchical}
             \PY{c+c1}{\PYZsh{} optimize allocation to industry}
             \PY{n}{industry\PYZus{}weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}
                 \PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                 \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                 \PY{k+kc}{False}\PY{p}{,}
                 \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                 \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{index}\PY{o}{=}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                 \PY{n}{data}\PY{o}{=}\PY{p}{[}\PY{l+m+mf}{0.1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                 \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{p}{,}
                 \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{}     \PYZsh{} equal weighting industries}
         \PY{c+c1}{\PYZsh{}     for i in industry\PYZus{}weights.keys():}
         \PY{c+c1}{\PYZsh{}         industry\PYZus{}weights[i] = 1/len(industries)}
         
             \PY{n+nb}{print}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
         
             \PY{c+c1}{\PYZsh{} Make same gross leverage}
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}equal} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{equal\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  23.340094968228197
IR gt\_oos:  24.84885845132815

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  76.99169498172355
IR sm\_oos:  8.955731023658574
\{'banks': 0.013780615233506703, 'oil': 0.14201227018473386, 'insurance':
0.009676804266535381, 'tech': 0.1345772540739004, 'bio': 0.07485637514027982,
'pharma': 0.2882964146265688, 'auto': 0.09892821969011271, 'retail': 0.21679805579151,
'manufacturing': 0.021073990992852218\}
IR hier\_is:  22.549160734242435
IR hier\_oos:  21.884894568370957
IR equal\_is:  11.650715442912684
IR equal\_oos:  11.084233419387685
MC run:  1

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_5.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  22.92867190408647
IR gt\_oos:  23.170266833792837
IR sm\_is:  74.99752490483553
IR sm\_oos:  7.932286299455993
\{'banks': 0.008673865012932838, 'oil': 0.13696938530822314, 'insurance':
0.03413376151438785, 'tech': 0.10079481907854868, 'bio': 0.09617349977702308,
'pharma': 0.4578338345314104, 'auto': 0.042503734567486295, 'retail':
0.11744146362216233, 'manufacturing': 0.005475636587825415\}
IR hier\_is:  19.45479460440231
IR hier\_oos:  20.96110798031804
IR equal\_is:  8.76685594886774
IR equal\_oos:  8.884783011184641
MC run:  2

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_7.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  24.431673309601646
IR gt\_oos:  22.601825803758434
IR sm\_is:  98.96400578208231
IR sm\_oos:  6.001669648530468
\{'banks': 0.13370146687337, 'oil': 0.13296288908238935, 'insurance':
0.014591912505559062, 'tech': 0.44063875012285514, 'bio': 0.0450204282887834,
'pharma': 0.04637352884084802, 'auto': 0.04375305187888432, 'retail':
0.03653236287277768, 'manufacturing': 0.10642560953453305\}
IR hier\_is:  23.034196892139907
IR hier\_oos:  20.18637458453616
IR equal\_is:  12.365793533596324
IR equal\_oos:  10.507026348853593
MC run:  3

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_9.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  26.042757016758102
IR gt\_oos:  25.796282333431822
IR sm\_is:  72.36143003438261
IR sm\_oos:  8.953162895837922
\{'banks': 0.21968478727204713, 'oil': 0.0856898170145167, 'insurance':
0.060503625526665994, 'tech': 0.22168916693319649, 'bio': 0.019822730861306873,
'pharma': 0.04252899736061094, 'auto': 0.0326994418276498, 'retail':
0.3060512450953407, 'manufacturing': 0.011330188108665467\}
IR hier\_is:  24.45578292152887
IR hier\_oos:  21.87804835274034
IR equal\_is:  11.44780915728
IR equal\_oos:  11.678691585772652
MC run:  4

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_11.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  22.866150834756066
IR gt\_oos:  25.937192783897746
IR sm\_is:  76.28198586700957
IR sm\_oos:  8.284362128742558
\{'banks': 0.19567336654918158, 'oil': 0.22524463256030877, 'insurance':
0.03956982323159401, 'tech': 0.0867524592445317, 'bio': 0.0224379455994546, 'pharma':
0.0525771683543378, 'auto': 0.0617386106474663, 'retail': 0.04824462808140622,
'manufacturing': 0.26776136573171905\}
IR hier\_is:  21.76476202899824
IR hier\_oos:  22.237800637760397
IR equal\_is:  8.272626714482918
IR equal\_oos:  8.281488422707096
MC run:  5

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_13.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  24.991006174755448
IR gt\_oos:  25.53447541003423
IR sm\_is:  67.6229032044295
IR sm\_oos:  7.29574772298956
\{'banks': 0.05481829529386708, 'oil': 0.08105231581549927, 'insurance':
0.035631920500844294, 'tech': 0.3783940384567301, 'bio': 0.028344282323862265,
'pharma': 0.10240989584046177, 'auto': 0.028203657317868797, 'retail':
0.21418086814093187, 'manufacturing': 0.07696472630993459\}
IR hier\_is:  23.122655767649963
IR hier\_oos:  21.78049267143243
IR equal\_is:  11.894338115022991
IR equal\_oos:  11.844717129179656
MC run:  6

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_15.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  23.255816789796604
IR gt\_oos:  25.13550051224693
IR sm\_is:  83.32910299237359
IR sm\_oos:  7.4890011847000615
\{'banks': 0.034170248653794984, 'oil': 0.36012327783126435, 'insurance':
0.06770286709489834, 'tech': 0.3000905606467104, 'bio': 0.0452897191198764, 'pharma':
0.018139468349847455, 'auto': 0.015012963229877815, 'retail': 0.12327740542470181,
'manufacturing': 0.03619348964902843\}
IR hier\_is:  19.884053516907798
IR hier\_oos:  20.721497297495137
IR equal\_is:  6.760463456459012
IR equal\_oos:  6.814176552114026
MC run:  7

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_17.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  22.582103773382933
IR gt\_oos:  21.88105832277189
IR sm\_is:  69.25628576129408
IR sm\_oos:  8.062956735413001
\{'banks': 0.09266494670331853, 'oil': 0.1621139284516062, 'insurance':
0.08895461994154263, 'tech': 0.14170959801178715, 'bio': 0.012026586822840859,
'pharma': 0.4619409256072568, 'auto': 0.014028723257752932, 'retail':
0.023002064246770756, 'manufacturing': 0.0035586069571242637\}
IR hier\_is:  20.694818600695832
IR hier\_oos:  16.495707392664173
IR equal\_is:  8.341255803239815
IR equal\_oos:  8.996928291255331
MC run:  8

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_19.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  23.378802235039917
IR gt\_oos:  21.97716459036835
IR sm\_is:  77.42238517121754
IR sm\_oos:  5.307559694586809
\{'banks': 0.015108423035486864, 'oil': 0.06385799400944106, 'insurance':
0.02487492623885332, 'tech': 0.2770196833495348, 'bio': 0.03346345613193343, 'pharma':
0.1926252390129665, 'auto': 0.12273120378951531, 'retail': 0.15587867684891427,
'manufacturing': 0.1144403975833544\}
IR hier\_is:  23.326987410488957
IR hier\_oos:  19.247278429260938
IR equal\_is:  9.975721579837979
IR equal\_oos:  9.0835738625144
MC run:  9

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_13_21.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  24.006165426224307
IR gt\_oos:  25.052633802340562
IR sm\_is:  85.38174228622609
IR sm\_oos:  8.836540543543606
\{'banks': 0.03625950480191997, 'oil': 0.08474190126356902, 'insurance':
0.13844759463987194, 'tech': 0.09310826023592658, 'bio': 0.20266693659819002,
'pharma': 0.2123862893186201, 'auto': 0.13561773966784968, 'retail':
0.027566316834781366, 'manufacturing': 0.06920545663927119\}
IR hier\_is:  24.28458907187489
IR hier\_oos:  23.219045552279002
IR equal\_is:  13.047933307889943
IR equal\_oos:  12.682292527145286

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}73}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Hierarchical}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equal Weighted}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. Hierarchical }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_14_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}74}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Equal / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Equal / Markowitz:  1.2948545494807482

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}75}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Markowitz:  2.7050687782142218

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}76}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Equal: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Equal:  2.089090839815936

    \end{Verbatim}

    The in-sample Markowitz IR is way above the ground truth IR. This may
seem curious, but is explained by the overfitting to in-sample data.
Whenever we are overfitting to in-sample data we can expect the
out-of-sample performance to suffer. This phenomenon is nicely
illustrated by the abysmal out-of-sample IR. The structure imposed by
the hierarchical method causes both the in-sample and out-of-sample
performance to be much closer to the ground truth. When the number of
assets is sufficiently high, equal weighting outperforms Markowitz. The
hierarchical method can improve upon equal weighting almost always. Note
that in this context equal weighting does not imply blindly allocating
equal weights to longs and short \emph{regardless of the industry}.
Instead, it assumes that in a prior step the alpha model picked roughly
equal numbers of longs and shorts of a certain industry. This follows
since the deterministic trend \(\mu\) is sampled uniformly with mean
zero. It is more appropriately thought of as a industry-matched equal
weighting scheme.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}77}]:} \PY{c+c1}{\PYZsh{} create a portfolio object and print some method outputs}
         \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                        \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                        \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                        \PY{n}{sector\PYZus{}id}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{str}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{.}\PY{n}{values}
                       \PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sector\PYZus{}net\PYZus{}exposures: }\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{sector\PYZus{}net\PYZus{}exposures}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 450 Assets, \$58.35 Long, \$58.35 Short
largest long: manufacturing\_stock\_4 0.9911231850379247
largest short: manufacturing\_stock\_28 -0.9068529604953223
sector\_net\_exposures:
            position\_value
sector\_id
aut             -0.039674
ban             -0.130852
bio              0.162993
ins              0.509072
man              0.469503
oil              0.011216
pha             -1.259297
ret              0.124053
tec              0.152986

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}78}]:} \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{head}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
                       position  price  factor\_value sector\_id  position\_value
manufacturing\_stock\_4  0.991123      1           1.0       man        0.991123
bio\_stock\_39           0.824076      1           1.0       bio        0.824076
bio\_stock\_20           0.782829      1           1.0       bio        0.782829
pharma\_stock\_14        0.727880      1           1.0       pha        0.727880
pharma\_stock\_38        0.727615      1           1.0       pha        0.727615

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}79}]:} \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}79}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a17fc79e8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_21_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{principal-component-analysis}{%
\subsection{Principal Component
Analysis}\label{principal-component-analysis}}

Principal Component Analysis (PCA) allows us to reduce the rank of the
covariance matrix. Since the covariance matrix is symmetric we can
decompose the matrix into its real eigenvalues and orthonormal
eigenvectors. This follows from the spectral theorem.
\[S=Q \Lambda Q^{-1}=Q \Lambda Q^{\mathrm{T}} \quad \text { with } \quad Q^{-1}=Q^{\mathrm{T}}\]
In the simulation we have exposure to the market and several industries.
Thus it makes sense to reduce the rank to the number of these variables.
Plotting the proportion of variance explained by the first n principal
components confirms this hypothesis.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}80}]:} \PY{k+kn}{from} \PY{n+nn}{sklearn}\PY{n+nn}{.}\PY{n+nn}{decomposition} \PY{k}{import} \PY{n}{PCA} \PY{k}{as} \PY{n}{sklearnPCA}
         
         \PY{n}{n\PYZus{}components} \PY{o}{=} \PY{l+m+mi}{20}
         \PY{n}{sklearn\PYZus{}pca} \PY{o}{=} \PY{n}{sklearnPCA}\PY{p}{(}\PY{n}{n\PYZus{}components}\PY{o}{=}\PY{n}{n\PYZus{}components}\PY{p}{)}
         \PY{n}{pc} \PY{o}{=} \PY{n}{sklearn\PYZus{}pca}\PY{o}{.}\PY{n}{fit\PYZus{}transform}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{bar}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}components}\PY{p}{)}\PY{p}{,}\PY{n}{sklearn\PYZus{}pca}\PY{o}{.}\PY{n}{explained\PYZus{}variance\PYZus{}ratio\PYZus{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Variance Explained by PC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_23_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}81}]:} \PY{c+c1}{\PYZsh{} denoise covariance matrix}
         \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
         \PY{n}{cov\PYZus{}mean} \PY{o}{=} \PY{n}{cov}\PY{o}{.}\PY{n}{values}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{cov\PYZus{}mean}\PY{p}{)}
         \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
         
         \PY{n}{evalues}\PY{p}{,} \PY{n}{Q} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{eig}\PY{p}{(}\PY{n}{cov}\PY{o}{\PYZhy{}}\PY{n}{cov\PYZus{}mean}\PY{p}{)}
         \PY{n}{evalues}\PY{p}{[}\PY{n}{evalues} \PY{o}{\PYZlt{}} \PY{n}{evalues}\PY{p}{[}\PY{n}{n\PYZus{}components}\PY{p}{]}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{Q\PYZus{}T} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{matrix}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{Q}\PY{p}{)}
         \PY{n}{L} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{n}{evalues}\PY{p}{)}
         \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{Q}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{L}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Q\PYZus{}T}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{real}\PY{p}{)}\PY{o}{+}\PY{n}{cov\PYZus{}mean}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
7.283488201566099e-05

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}82}]:} \PY{k}{def} \PY{n+nf}{cov\PYZus{}dist}\PY{p}{(}\PY{n}{corr0}\PY{p}{,} \PY{n}{corr1}\PY{p}{)}\PY{p}{:}
             \PY{n}{num} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{trace}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{corr0}\PY{p}{,} \PY{n}{corr1}\PY{p}{)}\PY{p}{)}
             \PY{n}{den} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{corr0}\PY{p}{,} \PY{n+nb}{ord}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{den} \PY{o}{*}\PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{corr1}\PY{p}{,} \PY{n+nb}{ord}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{cmd} \PY{o}{=} \PY{l+m+mi}{1} \PY{o}{\PYZhy{}} \PY{n}{num} \PY{o}{/} \PY{n}{den}
             \PY{k}{return} \PY{n}{cmd}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}83}]:} \PY{n}{cov\PYZus{}dist}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}83}]:} 0.0028991081404758923
\end{Verbatim}
            
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}84}]:} \PY{n}{cov\PYZus{}dist}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}84}]:} 0.01918395707307663
\end{Verbatim}
            
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}85}]:} \PY{c+c1}{\PYZsh{} pc\PYZus{}cov.shape}
         \PY{c+c1}{\PYZsh{} np.linalg.matrix\PYZus{}rank(pc\PYZus{}cov)}
         \PY{c+c1}{\PYZsh{} np.linalg.cond(pc\PYZus{}cov)}
         \PY{c+c1}{\PYZsh{} np.linalg.cond(cov)}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}86}]:} \PY{c+c1}{\PYZsh{} weights\PYZus{}closed\PYZus{}form = (np.linalg.inv(pc\PYZus{}cov).dot(expected\PYZus{}returns\PYZus{}all)/}
         \PY{c+c1}{\PYZsh{}}
         \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}87}]:} \PY{c+c1}{\PYZsh{} pf = Portfolio(assets=weights.keys(),}
         \PY{c+c1}{\PYZsh{}                position=weights\PYZus{}closed\PYZus{}form,}
         \PY{c+c1}{\PYZsh{}                price=[1]*len(weights.keys()),}
         \PY{c+c1}{\PYZsh{}                sector\PYZus{}id=pd.Series(list(weights.keys())).str[:3].values)}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}88}]:} \PY{c+c1}{\PYZsh{} pf.portfolio\PYZus{}df.position\PYZus{}value.plot(style=\PYZsq{}.\PYZsq{})}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}89}]:} \PY{k+kn}{import} \PY{n+nn}{seaborn} \PY{k}{as} \PY{n+nn}{sns}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}89}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1c445e80>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_32_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}90}]:} \PY{c+c1}{\PYZsh{} plot sample covariance matrix to compare}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}90}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1c61ac88>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_33_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}91}]:} \PY{c+c1}{\PYZsh{} compute ground truth covariance matrix to compare}
         \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
         \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
         \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{cov\PYZus{}truth}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}91}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1c5c76a0>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_34_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The heatmaps above look almost indistinguishable after eliminating all
other components.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}59}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industry} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                     \PY{n}{market}\PY{p}{,}
                                                                     \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                     \PY{n}{i}\PY{p}{,}
                                                                     \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                     \PY{n}{p\PYZus{}year}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground thruth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} standard sample moments}
             \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} PCA}
             \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{cov\PYZus{}mean} \PY{o}{=} \PY{n}{cov}\PY{o}{.}\PY{n}{values}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{)}
             \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{pc\PYZus{}cov}\PY{p}{(}\PY{n}{cov}\PY{o}{\PYZhy{}}\PY{n}{cov\PYZus{}mean}\PY{p}{,} \PY{n}{n}\PY{p}{)} \PY{o}{+} \PY{n}{cov\PYZus{}mean}
         
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{pc\PYZus{}cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  22.327779670589262
IR gt\_oos:  23.47178430290095

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  53.802340063882774
IR sm\_oos:  7.055504320705678
IR pca\_is:  21.347357187366764
IR pca\_oos:  22.13523148734668
MC run:  1

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_5.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  25.101144809904547
IR gt\_oos:  24.853227124511694
IR sm\_is:  70.82443442413046
IR sm\_oos:  8.239623585708864
IR pca\_is:  23.49806542609442
IR pca\_oos:  23.60890179698081
MC run:  2

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_7.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  23.42049879805346
IR gt\_oos:  24.661784287006622
IR sm\_is:  78.4440836534776
IR sm\_oos:  9.070363489612662
IR pca\_is:  22.359102803798066
IR pca\_oos:  22.732557900888644
MC run:  3

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_9.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  24.29064031726839
IR gt\_oos:  23.527850344912522
IR sm\_is:  99.12060509317666
IR sm\_oos:  6.274097276225852
IR pca\_is:  23.41472636652444
IR pca\_oos:  21.816446100957062
MC run:  4

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_11.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  23.937900532009124
IR gt\_oos:  26.454560476837617
IR sm\_is:  84.48418297695724
IR sm\_oos:  6.850278747764034
IR pca\_is:  22.408453458941437
IR pca\_oos:  24.964997963748075
MC run:  5

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_13.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  23.92122605927581
IR gt\_oos:  22.43413617839009
IR sm\_is:  86.6049788733028
IR sm\_oos:  6.929143230389251
IR pca\_is:  22.123143020121717
IR pca\_oos:  20.20262501817184
MC run:  6

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_15.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  22.983269270061818
IR gt\_oos:  23.82994484706046
IR sm\_is:  60.60154130511508
IR sm\_oos:  7.508591171194288
IR pca\_is:  20.766612623104535
IR pca\_oos:  21.861266650928304
MC run:  7

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_17.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  22.611953528427886
IR gt\_oos:  23.331746728303457
IR sm\_is:  69.96084806741126
IR sm\_oos:  8.863754443027098
IR pca\_is:  21.036102862175238
IR pca\_oos:  21.872112196223508
MC run:  8

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_19.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  24.12227104667446
IR gt\_oos:  24.79061749922558
IR sm\_is:  67.26436300927361
IR sm\_oos:  9.38671204728488
IR pca\_is:  23.304190501672466
IR pca\_oos:  22.913317626654727
MC run:  9

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_21.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  24.18494912078142
IR gt\_oos:  21.894938802777837
IR sm\_is:  82.53623112925658
IR sm\_oos:  7.006296765579034
IR pca\_is:  23.680358744003545
IR pca\_oos:  20.42342839489186

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}60}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PCA}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. PCA }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_37_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}61}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS PCA / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS PCA / Markowitz:  2.883108320103103

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}62}]:} \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{cov}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
450
11

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}63}]:} \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                        \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                        \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                        \PY{n}{sector\PYZus{}id}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{str}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sector\PYZus{}net\PYZus{}exposures:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{sector\PYZus{}net\PYZus{}exposures}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 450 Assets, \$122.79 Long, \$122.79 Short
largest long: insurance\_stock\_36 0.8462782815485712
largest short: insurance\_stock\_42 -0.8892452760063864
sector\_net\_exposures:
            position\_value
sector\_id
aut             -1.652076
ban              1.216688
bio             -0.806726
ins             -1.310240
man             -1.492269
oil              1.145051
pha              0.029748
ret              1.761821
tec              1.108004

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}64}]:} \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}64}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a19daaa58>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_41_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    PCA reduced extreme positions and set a lot fewer weights close to zero.

    \hypertarget{robustness-under-fat-tailed-noise-distribution}{%
\subsection{Robustness under fat-tailed noise
distribution}\label{robustness-under-fat-tailed-noise-distribution}}

The Generalized Autoregressive Conditional Heteroskedasticity (GARCH)
model is defined by:

\(\begin{aligned} r_{t} &=\mu_{t}+\epsilon_{t} \\ \epsilon_{t} &=\sigma_{t} \eta_{t}, \quad \eta_{t} \stackrel{i i d}{\sim}(0,1) \\ \sigma_{t}^{2} &=\omega+\sum_{i=1}^{q} \alpha_{i} \epsilon_{t-i}^{2}+\sum_{i=1}^{p} \beta_{i} \sigma_{t-i}^{2} \\ \omega &>0, \quad \alpha_{i} \geq 0, \quad i=1, \ldots, q, \quad \beta_{i} \geq 0, \quad i=1, \ldots, p \end{aligned}\)

The unconditional variance becomes:

\(\begin{aligned} \mathrm{E}\left(\sigma_{t}^{2}\right) &=\omega+\sum_{i=1}^{q} \alpha_{i} \mathrm{E}\left(\epsilon_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\sum_{i=1}^{q} \alpha_{i} \mathrm{E}\left(\eta_{t-i}^{2} \sigma_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\sum_{i=1}^{q} \alpha_{i} \underbrace{\mathrm{E}\left(\eta_{t-i}^{2}\right)}_{=1} \mathrm{E}\left(\sigma_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\left(\sum_{i=1}^{q} \alpha_{i}+\sum_{i=1}^{p} \beta_{i}\right) \mathrm{E}\left(\sigma_{t}^{2}\right) \end{aligned}\)

\(\begin{array}{l}{\text { Solving for } \mathrm{E}\left(\sigma_{t}^{2}\right), \text { we have the unconditional variance }} \\ {\qquad \begin{aligned} \mathrm{E}\left(\epsilon_{t}^{2}\right) &=\mathrm{E}\left(\sigma_{t}^{2}\right) \\ &=\frac{\omega}{1-\sum_{i=1}^{q} \alpha_{i}-\sum_{i=1}^{p} \beta_{i}} \end{aligned}}\end{array}\)

Equity curves under this noise distribution look like this.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}92}]:} \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         \PY{n}{banks} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         \PY{n}{stocks}\PY{p}{,} \PY{o}{*}\PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{banks}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                                       \PY{n}{sigma\PYZus{}noise}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{p}{,} \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                       \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{)}
         \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_44_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    As you can see, returns are much more extreme than under Gaussian noise.

First let's compare Markowitz vs.~hierachrichal vs.~equal weighting
under a GARCH(1,1) noise distribution.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}93}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                           \PY{n}{market}\PY{p}{,}
                                                                           \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                           \PY{n}{i}\PY{p}{,}
                                                                           \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                           \PY{n}{p\PYZus{}year}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}alpha}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}beta}\PY{p}{)}
         
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
                 \PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                              \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                              \PY{k+kc}{True}\PY{p}{,}
                                              \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                              \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
         \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                              \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
                 \PY{n}{industries\PYZus{}portfolio}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                                  \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground truth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} GARCH uncond Var}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{p}{(}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}alpha}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}beta}\PY{p}{)}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{}standard sample moments}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,}
                                                  \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} hierarchical}
             \PY{c+c1}{\PYZsh{} optimize allocation to industry}
             \PY{n}{industry\PYZus{}weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                          \PY{k+kc}{False}\PY{p}{,}
                                                          \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{index}\PY{o}{=}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{data}\PY{o}{=}\PY{p}{[}\PY{l+m+mf}{0.1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
         \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{p}{,}
                                                          \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}     \PYZsh{} equal weighting industries}
         \PY{c+c1}{\PYZsh{}     for i in industry\PYZus{}weights.keys():}
         \PY{c+c1}{\PYZsh{}         industry\PYZus{}weights[i] = 1/len(industries)}
         
             \PY{n+nb}{print}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
         
             \PY{c+c1}{\PYZsh{} Make same gross leverage}
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} Make same gross leverage}
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}equal} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{equal\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  11.466015963253206
IR gt\_oos:  10.545295300471533

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  24.56732172672373
IR sm\_oos:  2.777713774203299
\{'banks': 0.12883088365284823, 'oil': 0.11917174656339015, 'insurance':
0.033652923282206954, 'tech': 0.0698561496377195, 'bio': 0.049429979240176614,
'pharma': 0.2902182633232347, 'auto': 0.1030725603868126, 'retail':
0.16527133112132164, 'manufacturing': 0.040496162792289465\}
IR hier\_is:  11.340827518178601
IR hier\_oos:  9.815197947097037
IR equal\_is:  7.294826260330567
IR equal\_oos:  6.759005076451435
MC run:  1

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_5.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  11.252591875374707
IR gt\_oos:  11.669427244007899
IR sm\_is:  36.72283174655992
IR sm\_oos:  4.89030429598662
\{'banks': 0.0752838506060012, 'oil': 0.11585004633765635, 'insurance':
0.04797055434153544, 'tech': 0.03225225048094753, 'bio': 0.17473729230272128,
'pharma': 0.30948456399931046, 'auto': 0.0947240793977233, 'retail':
0.08054945871449579, 'manufacturing': 0.0691479038196087\}
IR hier\_is:  11.583914936413338
IR hier\_oos:  9.845786909714171
IR equal\_is:  6.084729740614245
IR equal\_oos:  6.218050407789197
MC run:  2

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_7.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  10.40325557232364
IR gt\_oos:  12.472948957872351
IR sm\_is:  45.41754500831745
IR sm\_oos:  3.800358842959666
\{'banks': 0.11815631590124819, 'oil': 0.08370554925019712, 'insurance':
0.11308255686500722, 'tech': 0.15167825368747573, 'bio': 0.12659824513747908,
'pharma': 0.17863859519430603, 'auto': 0.03299228716172744, 'retail':
0.10605798486946974, 'manufacturing': 0.08909021193308952\}
IR hier\_is:  11.586992489408901
IR hier\_oos:  11.118146041996376
IR equal\_is:  6.863073296689059
IR equal\_oos:  7.22453563239465
MC run:  3

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_9.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  11.914482249249051
IR gt\_oos:  10.279260770415764
IR sm\_is:  18.577489241533414
IR sm\_oos:  2.660319253576504
\{'banks': 0.13369031920961644, 'oil': 0.1535017321466058, 'insurance':
0.1314658042729921, 'tech': 0.08370134017040906, 'bio': 0.1254636404813916, 'pharma':
0.17633965875469454, 'auto': 0.078462877653937, 'retail': 0.0380861198697822,
'manufacturing': 0.07928850744057132\}
IR hier\_is:  12.743153352923105
IR hier\_oos:  9.534777747024371
IR equal\_is:  8.5598487004829
IR equal\_oos:  8.020518135915918
MC run:  4

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_11.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  11.339117885115076
IR gt\_oos:  11.311709060622647
IR sm\_is:  45.0588656927026
IR sm\_oos:  5.270713018481207
\{'banks': 0.06588094713182258, 'oil': 0.22018934385961464, 'insurance':
0.12923029737156186, 'tech': 0.10509550875517538, 'bio': 0.09784767227896114,
'pharma': 0.11853222991816907, 'auto': 0.0959249811217277, 'retail':
0.06718957701379533, 'manufacturing': 0.10010944254917235\}
IR hier\_is:  12.85640042054815
IR hier\_oos:  11.175390305398258
IR equal\_is:  6.919100827280759
IR equal\_oos:  6.852161826727482
MC run:  5

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_13.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  11.405258732751918
IR gt\_oos:  9.562670584881868
IR sm\_is:  34.28347292503075
IR sm\_oos:  1.6352374198549882
\{'banks': 0.1592642123670098, 'oil': 0.04348239450529035, 'insurance':
0.07778101358597794, 'tech': 0.04230872044357792, 'bio': 0.11530466386977967,
'pharma': 0.09004074351012842, 'auto': 0.12504580373783022, 'retail':
0.2633283854318897, 'manufacturing': 0.08344406254851593\}
IR hier\_is:  11.79144120798872
IR hier\_oos:  8.245909993706013
IR equal\_is:  8.23171016886631
IR equal\_oos:  7.377670865175384
MC run:  6

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_15.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  11.584822309011468
IR gt\_oos:  9.138935714298743
IR sm\_is:  46.22759397906164
IR sm\_oos:  2.744565118961362
\{'banks': 0.04695412567921421, 'oil': 0.1461744624836076, 'insurance':
0.010303704022059027, 'tech': 0.23318794452846045, 'bio': 0.07246069640823397,
'pharma': 0.27296406042569415, 'auto': 0.047367577978163725, 'retail':
0.08936213524059948, 'manufacturing': 0.0812252932339673\}
IR hier\_is:  10.571616994327336
IR hier\_oos:  7.9060383816128
IR equal\_is:  6.868882816870544
IR equal\_oos:  5.829300434216682
MC run:  7

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_17.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  10.942575180774726
IR gt\_oos:  11.391487454355012
IR sm\_is:  34.323311152491726
IR sm\_oos:  3.589991320093684
\{'banks': 0.08095657956564971, 'oil': 0.07470414646485106, 'insurance':
0.060873775585545326, 'tech': 0.3155043418134584, 'bio': 0.04315509257101283,
'pharma': 0.1904437079254446, 'auto': 0.08752030916424638, 'retail':
0.04627844699220553, 'manufacturing': 0.10056359991758629\}
IR hier\_is:  11.639362634571908
IR hier\_oos:  10.7566443867366
IR equal\_is:  7.338450173152181
IR equal\_oos:  6.024026816101417
MC run:  8

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_19.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  11.314131864753245
IR gt\_oos:  10.189807481406175
IR sm\_is:  24.29436479484996
IR sm\_oos:  3.6976978228797575
\{'banks': 0.13694293962451007, 'oil': 0.0713312181131816, 'insurance':
0.05052037549290519, 'tech': 0.15803648924317365, 'bio': 0.08670867764640053,
'pharma': 0.235242559499063, 'auto': 0.08409028726512993, 'retail':
0.045007198845270865, 'manufacturing': 0.13212025427036522\}
IR hier\_is:  10.786283035243066
IR hier\_oos:  9.101562960138448
IR equal\_is:  6.954412369834394
IR equal\_oos:  6.366962592902686
MC run:  9

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_46_21.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is:  12.475883380288082
IR gt\_oos:  11.153592087178119
IR sm\_is:  32.553145414913295
IR sm\_oos:  4.135221122554849
\{'banks': 0.14436097328915878, 'oil': 0.08998102839366623, 'insurance':
0.11070505058822581, 'tech': 0.10947743077812186, 'bio': 0.16593405498032845,
'pharma': 0.12202713357598813, 'auto': 0.10436272535851322, 'retail':
0.09278710628805323, 'manufacturing': 0.06036449674794429\}
IR hier\_is:  13.708256384265477
IR hier\_oos:  9.941779680136328
IR equal\_is:  9.880530425251155
IR equal\_oos:  8.959783982836568

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}94}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Hierarchical}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equal Weighted}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. Hierarchical }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_47_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}95}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Markowitz:  2.7680500164871074

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}96}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Equal / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Equal / Markowitz:  1.9780630210638535

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}97}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Equal: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Equal:  1.399374027526372

    \end{Verbatim}

    Under fat-tails Markowitz performs even worse since extreme positions
expose the portfolio to asset specific tail risk. In particular,
Markowitz underperforms equal weighting significantly. The hierarchical
method still outperforms equal weighting, though.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}98}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                           \PY{n}{market}\PY{p}{,}
                                                                           \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                           \PY{n}{i}\PY{p}{,}
                                                                           \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                           \PY{n}{p\PYZus{}year}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}alpha}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}beta}
                                                                           \PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground truth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} GARCH uncond Var}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{p}{(}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}alpha}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}beta}\PY{p}{)}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} standard sample moments}
             \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} PCA}
             \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{cov\PYZus{}mean} \PY{o}{=} \PY{n}{cov}\PY{o}{.}\PY{n}{values}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{)}
             \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{pc\PYZus{}cov}\PY{p}{(}\PY{n}{cov}\PY{o}{\PYZhy{}}\PY{n}{cov\PYZus{}mean}\PY{p}{,} \PY{n}{n}\PY{p}{)} \PY{o}{+} \PY{n}{cov\PYZus{}mean}
         
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{pc\PYZus{}cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 12.651988159357627
IR gt\_oos 12.396596738687132

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  35.67554748930204
IR sm\_oos:  3.5886144601105574
IR pca\_is:  11.723523668600246
IR pca\_oos:  11.619604467670277
MC run:  1

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_5.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 12.359781766605892
IR gt\_oos 11.539901022290252
IR sm\_is:  39.99592617366191
IR sm\_oos:  2.618285541761696
IR pca\_is:  11.406285104524494
IR pca\_oos:  10.921434933769946
MC run:  2

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_7.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 10.586439918995474
IR gt\_oos 11.567416233500039
IR sm\_is:  36.17296935279856
IR sm\_oos:  3.5985367123193392
IR pca\_is:  9.672011861710288
IR pca\_oos:  10.995837038898319
MC run:  3

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_9.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 10.609920064427657
IR gt\_oos 11.707503443739451
IR sm\_is:  47.74253734787293
IR sm\_oos:  4.032537794362301
IR pca\_is:  10.069199973702043
IR pca\_oos:  10.511123507571028
MC run:  4

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_11.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 10.398774741129852
IR gt\_oos 11.531257941357945
IR sm\_is:  45.421764637718624
IR sm\_oos:  4.2532889380036885
IR pca\_is:  10.076656304588647
IR pca\_oos:  10.734208907931896
MC run:  5

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_13.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 11.646293995119173
IR gt\_oos 12.008589728886246
IR sm\_is:  37.1261381646745
IR sm\_oos:  4.3910400441536845
IR pca\_is:  11.375628364869787
IR pca\_oos:  10.77994298981338
MC run:  6

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_15.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 10.306919528506828
IR gt\_oos 10.908550451908418
IR sm\_is:  26.412179974896116
IR sm\_oos:  3.932847673268968
IR pca\_is:  10.406844183840237
IR pca\_oos:  9.706317195660008
MC run:  7

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_17.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 9.789833457127461
IR gt\_oos 11.561464658764566
IR sm\_is:  21.362116738082474
IR sm\_oos:  2.321733985153855
IR pca\_is:  8.721256659884057
IR pca\_oos:  10.793683529364433
MC run:  8

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_19.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 10.683380092702254
IR gt\_oos 9.942365334902894
IR sm\_is:  46.12747982188347
IR sm\_oos:  3.2973332580190013
IR pca\_is:  10.197769771627044
IR pca\_oos:  9.133148466556378
MC run:  9

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_52_21.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR gt\_is 11.737286822940108
IR gt\_oos 10.803523139246135
IR sm\_is:  37.98478357996682
IR sm\_oos:  4.372384011487485
IR pca\_is:  11.343939628756928
IR pca\_oos:  10.277394838985526

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}99}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS PCA / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS PCA / Markowitz:  2.897076048552612

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}100}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{]}
          \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{]}
          
          \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PCA}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
          
          \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
              \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
              \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
          
          \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
          
          \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
          \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
          \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
          \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
          
          \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
          \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          
          \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. PCA }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
          \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
          \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_54_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The PCA method, too, outperforms Markowitz by a large margin under
fat-tails.

    \hypertarget{conclusion}{%
\subsection{Conclusion}\label{conclusion}}

Industry-neutral equal weighting can go a long way. If the number of
assets is large, it tends to outperform mean-variance optimization based
on sample moments. It certainly is better than long-only portfolio
construction. If one is willing to invest the effort to go beyond naive
approaches, imposing structure by hierarchical methods, shrinkage
estimation or noise reduction via PCA seem to be good approaches based
on Monte Carlo evidence. In addition, I showed that these methods are
robust to asset-specific fat-tailed noise by having fewer extreme and
instead more numerous moderate position weights.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor} }]:} 
\end{Verbatim}


    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
