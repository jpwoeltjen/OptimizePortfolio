
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    \usepackage{mathrsfs}
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}
    \definecolor{ansi-default-inverse-fg}{HTML}{FFFFFF}
    \definecolor{ansi-default-inverse-bg}{HTML}{000000}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatibility definitions
    \def\gt{>}
    \def\lt{<}
    \let\Oldtex\TeX
    \let\Oldlatex\LaTeX
    \renewcommand{\TeX}{\textrm{\Oldtex}}
    \renewcommand{\LaTeX}{\textrm{\Oldlatex}}
    % Document parameters
    % Document title
    \title{demo}
    
    
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \hypertarget{portfolio-optimization}{%
\section{Portfolio Optimization}\label{portfolio-optimization}}

    Let's simulate a bunch of stocks belonging to different industries. Each
stock is composed of a deterministic trend \(\mu\), a loading on the
market related stochastic trend \(\beta_{market}\) and a loading on the
industry specific stochastic trend \(\beta_{industry}\). For each stock,
\(\mu\), \(\beta_{market}\), and \(\beta_{industry}\) are sampled from a
uniform distribution. In the first simulation, I compare a mean-variance
optimization with a naive diversification approach where each asset is
equally weighted with the sign of the expected value. At this point I
should emphasize that I assume perfect knowledge of the expected value.
Traditionally, the expected value is estimated by the in-sample first
moment of the asset. In my example, this would actually make sense since
the mean is a consistent estimator of the deterministic trend. In
practice, however, there is probably not a constant deterministic trend.
This is where the alpha model steps in, which is not the topic of this
study and thus assumed given.

The return of each stock is thus given by

\[\begin{aligned} R_{i t} &=\mu_{i}+\beta_{i 1} f_{1 t}+\beta_{i 2} f_{2 t}+\cdots+\beta_{i k} f_{k t}+\epsilon_{i t} \\ &=\mu_{i}+\sum_{\ell=1}^{k} \beta_{i \ell} f_{\ell t}+\epsilon_{i t}, \quad i=1, \ldots, N, \quad t=1, \ldots, T \end{aligned}\]

\(\begin{array}{l}{R_{i t} \text { is the return of asset } i \text { at time } t, i=1, \ldots, N} \\ {f_{\ell t} \text { is the } \ell \text { th common factor at time } t, \ell=1, \ldots, k} \\ {\beta_{i \ell} \text { is the factor loading or factor beta of asset } i \text { with respect to factor }} \\ {\ell, i=1, \ldots, N, \ell=1, \ldots, k} \\ {\epsilon_{i t} \text { is the asset-specific factor or asset-specific risk. }}\end{array}\)

\(\begin{array}{l}{\text { The } k \times k \text { covariance matrix of the factors is }} \\ {\qquad \operatorname{Cov}\left(\boldsymbol{f}_{t}\right)=\boldsymbol{\Sigma}_{f}} \\ {\text { where }} \\ {\qquad \boldsymbol{f}_{t}=\left[f_{1 t}, f_{2 t}, \ldots, f_{k t}\right]^{\prime}}\end{array}\)

\(\text {Asset-specific noise is uncorrelated with the factors } \operatorname{Cov}\left(f_{\ell t}, \epsilon_{i t}\right)=0, \quad \ell=1, \ldots, k, \quad i=1, \ldots, N, \quad t=1, \ldots, T\),

\(\boldsymbol{\Sigma}_{\boldsymbol{\epsilon}}=\operatorname{Cov}\left(\boldsymbol{\epsilon}_{t}\right)=\left[\begin{array}{cccc}{\sigma_{\epsilon_{1}}^{2}} & {0} & {\cdots} & {0} \\ {0} & {\sigma_{\epsilon_{2}}^{2}} & {\cdots} & {0} \\ {\vdots} & {\vdots} & {\ddots} & {\vdots} \\ {0} & {0} & {\cdots} & {\sigma_{\epsilon_{N}}^{2}}\end{array}\right]=\operatorname{diag}\left(\sigma_{\epsilon_{1}}^{2}, \sigma_{\epsilon_{2}}^{2}, \ldots, \sigma_{\epsilon_{N}}^{2}\right)\),

\(\begin{array}{l}{\text { The asset-specific risks are likewise uncorrelated across assets, and for }} \\ {\text { each asset they are serially uncorrelated, }} \\ {\qquad \operatorname{Cov}\left(\epsilon_{i t}, \epsilon_{j t^{\prime}}\right)=\left\{\begin{array}{ll}{\sigma_{i}^{2}} & {\text { if } i=j \text { and } t=t^{\prime}} \\ {0} & {\text { otherwise }}\end{array}\right.}\end{array}\)

Thus a diagonal covariance structure reflects the assumption that all
correlation between assets is due to the factors.

\(\begin{array}{l}{\text { If we write the factor model as }} \\ {\qquad \boldsymbol{R}_{t}=\boldsymbol{\alpha}+\boldsymbol{B} \boldsymbol{f}_{t}+\boldsymbol{\epsilon}_{t}, \quad t=1, \ldots, T}\end{array}\)

\(\begin{array}{l}{\text { where in the } N \times k \text { matrix }} \\ {\qquad B=\left[\begin{array}{c}{\boldsymbol{\beta}_{1}^{\prime}} \\ {\boldsymbol{\beta}_{2}^{\prime}} \\ {\vdots} \\ {\boldsymbol{\beta}_{N}^{\prime}}\end{array}\right]=\left[\begin{array}{cccc}{\beta_{11}} & {\beta_{12}} & {\cdots} & {\beta_{1 k}} \\ {\beta_{21}} & {\beta_{22}} & {\cdots} & {\beta_{2 k}} \\ {\vdots} & {\vdots} & {\ddots} & {\vdots} \\ {\beta_{N 1}} & {\beta_{N 2}} & {\cdots} & {\beta_{N k}}\end{array}\right]} \\ {\text { the }} \ell {\text {th column contains the beta coefficients associated with factor } \ell}\end{array}\)

\(\begin{array}{l}{\text { The covariance matrix of the returns } R_{t}=\left[R_{1 t}, R_{2 t}, \ldots, R_{N t}\right] \text { implied }} \\ {\text { by the factor model is }} \\ {\qquad \Sigma=\operatorname{Cov}\left(R_{t}\right)=B \Sigma_{f} B^{\prime}+\Sigma_{\epsilon}}\end{array}\)

\(\begin{array}{l}{\text { That is, }} \\ {\qquad \begin{aligned} \operatorname{Var}\left(R_{i}\right) &=\beta_{i}^{\prime} \Sigma_{f} \beta_{i}+\sigma_{\epsilon_{i}}^{2} \\ \operatorname{Cov}\left(R_{i}, R_{j}\right) &=\beta_{i}^{\prime} \Sigma_{f} \beta_{j} \end{aligned}}\end{array}\)

\(\begin{array}{l}{\text { Since the factors are uncorrelated in this simulation, the covariance matrix }\text { simplifies to}} \\ {\qquad \Sigma=B \Sigma_{f} B^{\prime}+\Sigma_{\epsilon}=\sum_{\ell=1}^{k} \beta_{\ell} \beta_{\ell}^{\prime} e_{f_{\ell}}^{2}+\Sigma_{\epsilon}}\end{array}\)

\(\begin{array}{l}{\text { where }} \\ {\beta_{\ell} \text { is the vector of loadings with respect to factor } \ell, \text { i.e. the } \ell \text { th column }} \\ {\text { of matrix } \boldsymbol{B} \text { , }} \\ {\sigma_{f_{\ell}}^{2} \text { is the variance of factor } \ell}\end{array}\)

\(\text { Thus the variance of asset } i \text { is }\)
\[\sigma_{i}^{2}=\sum_{\ell=1}^{k} \beta_{i \ell}^{2} \sigma_{f_{\ell}}^{2}+\sigma_{\epsilon_{i}}^{2} \]

\(\text { and the covariance between the returns of assets } i \text { and } j \text { is }\)
\[ \sigma_{i j}=\sum_{\ell=1}^{k} \beta_{i \ell} \beta_{j \ell} \sigma_{f_{\ell}}^{2}\]

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}1}]:} \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{k+kn}{import} \PY{n+nn}{pandas} \PY{k}{as} \PY{n+nn}{pd}
        \PY{k+kn}{from} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{linalg} \PY{k}{import} \PY{n}{eigh}\PY{p}{,} \PY{n}{cholesky}
        \PY{k+kn}{from} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{stats} \PY{k}{import} \PY{n}{norm}
        \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{pyplot} \PY{k}{as} \PY{n}{plt}
        \PY{n}{plt}\PY{o}{.}\PY{n}{style}\PY{o}{.}\PY{n}{use}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seaborn}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} \PYZpc{}matplotlib notebook}
        \PY{k+kn}{from} \PY{n+nn}{src} \PY{k}{import} \PY{n}{optimize}
        \PY{k+kn}{from} \PY{n+nn}{src}\PY{n+nn}{.}\PY{n+nn}{portfolio} \PY{k}{import} \PY{n}{Portfolio}
        
        
        \PY{k}{def} \PY{n+nf}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{industry\PYZus{}name}\PY{p}{,} \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{)}\PY{p}{:}
            \PY{n}{mu} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{n}{p\PYZus{}year}
            \PY{n}{beta\PYZus{}market} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{stocks} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
        
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{:}
                \PY{n}{normal\PYZus{}noise} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma\PYZus{}noise}
                \PY{n}{stocks}\PY{p}{[}\PY{n}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+si}{\PYZob{}industry\PYZus{}name\PYZcb{}}\PY{l+s+s1}{\PYZus{}stock\PYZus{}}\PY{l+s+si}{\PYZob{}i\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{mu}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{market} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{industry} \PY{o}{+}
                                                        \PY{n}{normal\PYZus{}noise}\PY{p}{)}
            \PY{n}{mu}\PY{o}{.}\PY{n}{index} \PY{o}{=} \PY{n}{stocks}\PY{o}{.}\PY{n}{columns}
            \PY{k}{return} \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry}
        
        
        \PY{k}{def} \PY{n+nf}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{sigma\PYZus{}sq\PYZus{}0}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{alpha}\PY{p}{,} \PY{n}{beta}\PY{p}{,} \PY{n}{omega}\PY{p}{)}\PY{p}{:}
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{} generate GARCH log returns \PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{nu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{normal}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{n}{n}\PY{p}{)}
            \PY{n}{r} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{epsilon} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{sigma\PYZus{}sq} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{p}{)}
            \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{sigma\PYZus{}sq\PYZus{}0}
        
            \PY{k}{if} \PY{n+nb}{min}\PY{p}{(}\PY{n}{alpha}\PY{p}{,} \PY{n}{beta}\PY{p}{)} \PY{o}{\PYZlt{}} \PY{l+m+mi}{0}\PY{p}{:}
                \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{alpha, beta need to be non\PYZhy{}negative}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{k}{if} \PY{n}{omega} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{l+m+mi}{0}\PY{p}{:}
                \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{omega needs to be positive}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{alpha}\PY{o}{+}\PY{n}{beta} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{1}\PY{p}{:}
                \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{alpha+beta\PYZgt{}=1, variance not defined \PYZhy{}\PYZhy{}\PYZgt{}}\PY{l+s+se}{\PYZbs{}}
        \PY{l+s+s1}{              time series will not be weakly stationary}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n}\PY{p}{)}\PY{p}{:}
        
                \PY{k}{if} \PY{n}{i} \PY{o}{\PYZgt{}} \PY{l+m+mi}{0}\PY{p}{:}
                    \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{omega} \PY{o}{+}
                                   \PY{n}{alpha} \PY{o}{*} \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+}
                                   \PY{n}{beta} \PY{o}{*} \PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        
                \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{sigma\PYZus{}sq}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}\PY{p}{)} \PY{o}{*} \PY{n}{nu}\PY{p}{[}\PY{n}{i}\PY{p}{]}
        
                \PY{n}{r}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{mu} \PY{o}{+} \PY{n}{epsilon}\PY{p}{[}\PY{n}{i}\PY{p}{]}
            \PY{k}{return} \PY{n}{r}
        
        
        \PY{k}{def} \PY{n+nf}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{industry\PYZus{}name}\PY{p}{,}
                                      \PY{n}{sigma\PYZus{}noise}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{,} \PY{n}{garch\PYZus{}mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,}
                                      \PY{n}{garch\PYZus{}alpha}\PY{o}{=}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{o}{=}\PY{l+m+mf}{0.4}\PY{p}{)}\PY{p}{:}
            \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{} Generate stocks of given industry with fat\PYZhy{}tailed noise. \PYZdq{}\PYZdq{}\PYZdq{}}
            \PY{n}{mu} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{n}{p\PYZus{}year}
            \PY{n}{beta\PYZus{}market} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{n}{low}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{high}\PY{o}{=}\PY{l+m+mf}{2.0}\PY{p}{,} \PY{n}{size}\PY{o}{=}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{)}
            \PY{n}{stocks} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
            \PY{n}{garch\PYZus{}noise} \PY{o}{=} \PY{n}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                               \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,}
                                               \PY{n}{garch\PYZus{}mu}\PY{p}{,} \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{,}
                                               \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{)}\PY{p}{:}
                \PY{n}{garch\PYZus{}noise} \PY{o}{=} \PY{n}{generate\PYZus{}garch\PYZus{}11\PYZus{}ts}\PY{p}{(}\PY{n}{market}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                                                   \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{,}
                                                   \PY{n}{garch\PYZus{}mu}\PY{p}{,} \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{,}
                                                   \PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
        
                \PY{n}{stocks}\PY{p}{[}\PY{n}{f}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+si}{\PYZob{}industry\PYZus{}name\PYZcb{}}\PY{l+s+s1}{\PYZus{}stock\PYZus{}}\PY{l+s+si}{\PYZob{}i\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{mu}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{market} \PY{o}{+}
                                                        \PY{n}{beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{industry} \PY{o}{+}
                                                        \PY{n}{garch\PYZus{}noise}\PY{p}{)}
            \PY{n}{mu}\PY{o}{.}\PY{n}{index} \PY{o}{=} \PY{n}{stocks}\PY{o}{.}\PY{n}{columns}
            \PY{k}{return} \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry}
        
        
        \PY{k}{def} \PY{n+nf}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{equity\PYZus{}curve}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{o}{=}\PY{l+m+mi}{250}\PY{p}{)}\PY{p}{:}
            \PY{k}{return} \PY{n}{equity\PYZus{}curve}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{p}{)}\PY{o}{/}\PY{n}{equity\PYZus{}curve}\PY{o}{.}\PY{n}{std}\PY{p}{(}\PY{p}{)}\PY{o}{*}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        
        \PY{n}{p\PYZus{}year} \PY{o}{=} \PY{l+m+mi}{250}
        \PY{n}{num\PYZus{}samples} \PY{o}{=} \PY{n}{p\PYZus{}year}\PY{o}{*}\PY{l+m+mi}{4}
        
        \PY{n}{sigma} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.14}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.07}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.2}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.12}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.22}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.05}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.125}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        
        \PY{n}{sigma\PYZus{}noise} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{o}{/}\PY{n}{p\PYZus{}year}\PY{o}{*}\PY{o}{*}\PY{l+m+mf}{0.5}
        \PY{n}{MC\PYZus{}RUNS} \PY{o}{=} \PY{l+m+mi}{5}
        \PY{n}{PLOT\PYZus{}STOCKS} \PY{o}{=} \PY{k+kc}{False}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}2}]:} \PY{k}{def} \PY{n+nf}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{log\PYZus{}returns}\PY{p}{)}\PY{p}{:}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{exp}\PY{p}{(}\PY{n}{log\PYZus{}returns}\PY{o}{.}\PY{n}{cumsum}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equity Curve}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Period}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equity Value}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
        
        
        \PY{k}{def} \PY{n+nf}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{industry}\PY{p}{,} \PY{n}{long\PYZus{}only}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{:}
            \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
            \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
            \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        
            \PY{n}{stocks}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{beta\PYZus{}market}\PY{p}{,} \PY{n}{beta\PYZus{}industry} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}
                \PY{n}{n\PYZus{}stocks}\PY{p}{,}
                \PY{n}{market}\PY{p}{,}
                \PY{n+nb}{list}\PY{p}{(}\PY{n}{industry}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                \PY{n+nb}{list}\PY{p}{(}\PY{n}{industry}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}
                \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                \PY{n}{p\PYZus{}year}\PY{p}{)}
        
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{long\PYZus{}only}\PY{p}{:}
                \PY{n}{lower\PYZus{}bound} \PY{o}{=} \PY{l+m+mi}{0}
                \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{mu}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{k}{lambda} \PY{n}{x}\PY{p}{:} \PY{l+m+mi}{0} \PY{k}{if} \PY{n}{x} \PY{o}{\PYZlt{}}\PY{o}{=} \PY{l+m+mi}{0} \PY{k}{else} \PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{n}{mu}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                \PY{n}{market\PYZus{}neutral} \PY{o}{=} \PY{k+kc}{False}
            \PY{k}{else}\PY{p}{:}
                \PY{n}{lower\PYZus{}bound} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
                \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{mu}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{mu}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                \PY{n}{market\PYZus{}neutral} \PY{o}{=} \PY{k+kc}{True}
        
            \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{mu}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{n}{market\PYZus{}neutral}\PY{p}{,}
                                                  \PY{p}{(}\PY{n}{lower\PYZus{}bound}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{mu}\PY{p}{,} \PY{n}{stocks}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} Make same gross leverage}
            \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{}     print(\PYZsq{}|| In\PYZhy{}Sample Performance || \PYZbs{}n\PYZsq{})}
            \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,} \PY{n}{equal\PYZus{}weights}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{}     print(\PYZsq{}|| Out\PYZhy{}of\PYZhy{}Sample Performance || \PYZbs{}n\PYZsq{})}
            \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks}\PY{o}{.}\PY{n}{values}\PY{p}{,} \PY{n}{equal\PYZus{}weights}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
        
            \PY{k}{return} \PY{n}{weights}
\end{Verbatim}

    The results below show that out-of-sample (oos) performance of the
optimized portfolio using sample moments (sm) is decent if the number of
assets is relatively small. It definitely beats equal weighting (equal).

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}3}]:} \PY{n}{industry} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        \PY{n}{industry}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_5_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  12.651404211591572

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_5_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  9.236222264204967

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_5_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  9.910268820307552

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_5_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  9.236222264204967

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_5_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    As shown below, long-only performance, of course, is horrendous. This is
due to the fact that we cannot diversify the systematic risk. Since we
cannot short, hedging out that risk is also not possible. Hence, our
bets are not independent and the Law of Large Numbers does not apply.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}4}]:} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{,} \PY{n}{long\PYZus{}only}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_7_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  1.1077591138055525

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_7_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  0.3523053803647488

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_7_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  2.1694236324044276

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_7_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  0.3523053803647488

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_7_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Standard mean-variance optimization works well if the number of assets
is relatively small. When the number of assets is relatively large,
however, the out-of-sample performance is significantly worse than the
in-sample performance as demonstrated by the information ratio (IR).
Even the very naive approach of equal weighting beats mean-variance
optimization out-of-sample embarrassingly often.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}5}]:} \PY{n}{weights} \PY{o}{=} \PY{n}{show\PYZus{}standard\PYZus{}optimized\PYZus{}equity}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{=}\PY{l+m+mi}{300}\PY{p}{,} \PY{n}{industry}\PY{o}{=}\PY{n}{industry}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_9_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  34.85381862182288

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_9_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_is:  12.958840166422652

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_9_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_oos:  12.452707833288388

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_9_6.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR equal\_oos:  12.958840166422652

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_9_8.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}6}]:} \PY{c+c1}{\PYZsh{} creating portfolio object}
        \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                       \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                       \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 300 Assets, \$38.91 Long, \$38.91 Short
largest long: manufacturing\_stock\_212 0.7374611476838714
largest short: manufacturing\_stock\_93 -1.0

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}7}]:} \PY{c+c1}{\PYZsh{} Showing the first 5 positions in portfolio}
        \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{head}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}7}]:}                          position  price  factor\_value  sector\_id  \textbackslash{}
        manufacturing\_stock\_212  0.737461      1           1.0        0.0   
        manufacturing\_stock\_299  0.721744      1           1.0        0.0   
        manufacturing\_stock\_278  0.658798      1           1.0        0.0   
        manufacturing\_stock\_91   0.657564      1           1.0        0.0   
        manufacturing\_stock\_33   0.651608      1           1.0        0.0   
        
                                 position\_value  
        manufacturing\_stock\_212        0.737461  
        manufacturing\_stock\_299        0.721744  
        manufacturing\_stock\_278        0.658798  
        manufacturing\_stock\_91         0.657564  
        manufacturing\_stock\_33         0.651608  
\end{Verbatim}
            
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}8}]:} \PY{c+c1}{\PYZsh{} Plotting the weight distribution}
        \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Position Allocation}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ordered Positions}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Weight}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_12_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Here you can see a typical result of mean-variance optimization. There
are some very large positions. These are most likely due to estimation
errors of the covariance matrix and thus undesirable. This problem is
even greater when \(\mu\), too, is estimated with error. As the number
of assets grows, there is a higher likelihood of observing an extreme
covariance value by chance and thus this problem actually grows with the
number of assets. This is so common that it has a name. In the
literature it goes by `Error Maximization'.

    \hypertarget{imposing-structure}{%
\subsection{Imposing Structure}\label{imposing-structure}}

To reduce Error Maximization we need to impose structure. One way to do
this is by using our knowledge that stocks usually cluster (e.g., into
certain industries). It seems like a good idea to encode this prior
knowledge by mean-variance optimize stocks within clusters and then
optimize allocation to these clusters. This is pursued next and compared
to the standard optimization.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}9}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
        \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
        \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{ir\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
        
        \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
        
            \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
            \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
        \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        
            \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        
            \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
            \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
        
            \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
            \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                    \PY{n}{market}\PY{p}{,}
                                                                    \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                    \PY{n}{i}\PY{p}{,}
                                                                    \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                    \PY{n}{p\PYZus{}year}\PY{p}{)}
        
                \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
        
                \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,} \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
        
                \PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}
                     \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                     \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                     \PY{k+kc}{True}\PY{p}{,}
                     \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                     \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                     \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
                \PY{n}{industries\PYZus{}portfolio}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}
                    \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                    \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        
            \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} ground thruth}
            \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
            \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
            \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
            \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
            \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
            \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} standard sample moments}
            \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,}
                                                  \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                     \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
            \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
            \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{c+c1}{\PYZsh{} hierarchical}
            \PY{c+c1}{\PYZsh{} optimize allocation to industry}
            \PY{n}{industry\PYZus{}weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}
                \PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                \PY{k+kc}{False}\PY{p}{,}
                \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{index}\PY{o}{=}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                \PY{n}{data}\PY{o}{=}\PY{p}{[}\PY{l+m+mf}{0.1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{p}{,}
                \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{}     \PYZsh{} equal weighting industries}
        \PY{c+c1}{\PYZsh{}     for i in industry\PYZus{}weights.keys():}
        \PY{c+c1}{\PYZsh{}         industry\PYZus{}weights[i] = 1/len(industries)}
        
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{p}{)}
            \PY{n}{portfolio\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                    \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                    \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
        
            \PY{c+c1}{\PYZsh{} Make same gross leverage}
            \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
        
            \PY{n}{portfolio\PYZus{}equal} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                    \PY{n}{equal\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{)}
            \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
            \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
        
            \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
            \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is:  22.764742896098532
IR gt\_oos:  25.423096737395447

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  81.48841850109251
IR sm\_oos:  8.080572298936241
\{'banks': 0.1129615293128751, 'oil': 0.14377718823878444, 'insurance':
0.014058226197895225, 'tech': 0.25574763628860203, 'bio': 0.11006700677931346,
'pharma': 0.2816138500871653, 'auto': 0.033685980441805465, 'retail':
0.031187363281997244, 'manufacturing': 0.016901219371561752\}
IR hier\_is:  21.75333684206342
IR hier\_oos:  21.47607243677229
IR equal\_is:  8.934242690940316
IR equal\_oos:  10.597192555243918
MC run:  1
IR gt\_is:  24.24065757939983
IR gt\_oos:  24.084090939842696
IR sm\_is:  61.00200926194065
IR sm\_oos:  6.886453408141832
\{'banks': 0.12417886489545167, 'oil': 0.13952485969362854, 'insurance':
0.06895271343658817, 'tech': 0.31437383592800566, 'bio': 0.05407952882456184,
'pharma': 0.13957806647364773, 'auto': 0.10251699902607415, 'retail':
0.03122666292627042, 'manufacturing': 0.025568468795771876\}
IR hier\_is:  21.72164768576419
IR hier\_oos:  20.585302751567717
IR equal\_is:  16.334608097834664
IR equal\_oos:  16.14347365872683
MC run:  2
IR gt\_is:  22.898593588631904
IR gt\_oos:  24.81793868209896
IR sm\_is:  92.13530611917427
IR sm\_oos:  7.023607721552295
\{'banks': 0.012727478982841565, 'oil': 0.1298031410912971, 'insurance':
0.08402321976453021, 'tech': 0.12197948913655515, 'bio': 0.19117486045719584,
'pharma': 0.2449844422880232, 'auto': 0.10318305557951167, 'retail':
0.10458233928488639, 'manufacturing': 0.007541973415158882\}
IR hier\_is:  22.614677127228017
IR hier\_oos:  20.832201639311666
IR equal\_is:  10.152899371981803
IR equal\_oos:  8.557038995491695
MC run:  3
IR gt\_is:  24.226075720624188
IR gt\_oos:  25.17534926287912
IR sm\_is:  72.71040048334821
IR sm\_oos:  10.80162959604957
\{'banks': 0.04446499461729821, 'oil': 0.10251008614085398, 'insurance':
0.01228147959832786, 'tech': 0.4463644803362729, 'bio': 0.049745698303080677,
'pharma': 0.2437541747818386, 'auto': 0.020232478546664837, 'retail':
0.06916138316382736, 'manufacturing': 0.011485224511835599\}
IR hier\_is:  21.273039781724037
IR hier\_oos:  20.174332249361626
IR equal\_is:  6.897695450146542
IR equal\_oos:  5.948558102245953
MC run:  4
IR gt\_is:  22.47176220106334
IR gt\_oos:  22.076205524532817
IR sm\_is:  71.31430082387298
IR sm\_oos:  5.77684577884029
\{'banks': 0.13882612416254275, 'oil': 0.13751535739762402, 'insurance':
0.047784372997667725, 'tech': 0.3160644145571731, 'bio': 0.03827014948041616,
'pharma': 0.19184647320369733, 'auto': 0.044945218143515354, 'retail':
0.004103569090263107, 'manufacturing': 0.08064432096710052\}
IR hier\_is:  21.4003668898193
IR hier\_oos:  19.618852819668398
IR equal\_is:  9.203178199131479
IR equal\_oos:  9.636011379780278

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}10}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Hierarchical}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equal Weighted}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. Hierarchical }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_16_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}11}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Equal / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Equal / Markowitz:  1.3192494270659583

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}12}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Markowitz:  2.662409505487703

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}13}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Equal: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Equal:  2.0181244356565418

    \end{Verbatim}

    The in-sample Markowitz IR is way above the ground truth IR. This may
seem curious, but is explained by the overfitting to in-sample data.
Whenever we are overfitting to in-sample data we can expect the
out-of-sample performance to suffer. This phenomenon is nicely
illustrated by the abysmal out-of-sample IR. The structure imposed by
the hierarchical method causes both the in-sample and out-of-sample
performance to be much closer to the ground truth. When the number of
assets is sufficiently high, equal weighting outperforms Markowitz. The
hierarchical method can improve upon equal weighting almost always. Note
that in this context equal weighting does not imply blindly allocating
equal weights to longs and short \emph{regardless of the industry}.
Instead, it assumes that in a prior step the alpha model picked roughly
equal numbers of longs and shorts of a certain industry. This follows
since the deterministic trend \(\mu\) is sampled uniformly. It is more
appropriately thought of as a industry-matched equal weighting scheme.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}14}]:} \PY{c+c1}{\PYZsh{} create a portfolio object and print some method outputs}
         \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                        \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                        \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                        \PY{n}{sector\PYZus{}id}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{str}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{.}\PY{n}{values}
                       \PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sector\PYZus{}net\PYZus{}exposures: }\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{sector\PYZus{}net\PYZus{}exposures}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 450 Assets, \$43.76 Long, \$43.76 Short
largest long: oil\_stock\_13 0.6417725939631443
largest short: auto\_stock\_20 -0.9752070715541381
sector\_net\_exposures:
            position\_value
sector\_id
aut             -0.295522
ban             -0.405407
bio             -0.373189
ins              1.011198
man             -1.089961
oil             -0.484716
pha              0.945934
ret             -0.201969
tec              0.893630

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}15}]:} \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{head}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
                    position  price  factor\_value sector\_id  position\_value
oil\_stock\_13        0.641773      1           1.0       oil        0.641773
insurance\_stock\_17  0.622193      1           1.0       ins        0.622193
tech\_stock\_14       0.569854      1           1.0       tec        0.569854
retail\_stock\_23     0.563937      1           1.0       ret        0.563937
tech\_stock\_21       0.546087      1           1.0       tec        0.546087

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}16}]:} \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}16}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a176fab38>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_23_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \hypertarget{principal-component-analysis}{%
\subsection{Principal Component
Analysis}\label{principal-component-analysis}}

Principal Component Analysis (PCA) allows us to reduce the dimension of
the covariance matrix. Since the covariance matrix is symmetric we can
decompose the matrix into its real eigenvalues and orthonormal
eigenvectors. This follows from the spectral theorem.
\[S=Q \Lambda Q^{-1}=Q \Lambda Q^{\mathrm{T}} \quad \text { with } \quad Q^{-1}=Q^{\mathrm{T}}\]
In the simulation we have exposure to the market and several industries.
Thus it makes sense to reduce the dimension to the number of these
variables. Plotting the proportion of variance explained by the first n
principal components confirms this hypothesis.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}17}]:} \PY{k+kn}{from} \PY{n+nn}{sklearn}\PY{n+nn}{.}\PY{n+nn}{decomposition} \PY{k}{import} \PY{n}{PCA} \PY{k}{as} \PY{n}{sklearnPCA}
         
         \PY{n}{n\PYZus{}components} \PY{o}{=} \PY{l+m+mi}{20}
         \PY{n}{sklearn\PYZus{}pca} \PY{o}{=} \PY{n}{sklearnPCA}\PY{p}{(}\PY{n}{n\PYZus{}components}\PY{o}{=}\PY{n}{n\PYZus{}components}\PY{p}{)}
         \PY{n}{pc} \PY{o}{=} \PY{n}{sklearn\PYZus{}pca}\PY{o}{.}\PY{n}{fit\PYZus{}transform}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{bar}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}components}\PY{p}{)}\PY{p}{,}\PY{n}{sklearn\PYZus{}pca}\PY{o}{.}\PY{n}{explained\PYZus{}variance\PYZus{}ratio\PYZus{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Variance Explained by PC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_25_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}18}]:} \PY{c+c1}{\PYZsh{} denoise covariance matrix}
         \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
         \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
         
         \PY{n}{evalues}\PY{p}{,} \PY{n}{Q} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{eig}\PY{p}{(}\PY{n}{cov}\PY{p}{)}
         \PY{n}{evalues}\PY{p}{[}\PY{n}{evalues} \PY{o}{\PYZlt{}} \PY{n}{evalues}\PY{p}{[}\PY{n}{n\PYZus{}components}\PY{p}{]}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{Q\PYZus{}T} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{matrix}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{Q}\PY{p}{)}
         \PY{n}{L} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{n}{evalues}\PY{p}{)}
         \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{Q}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{L}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Q\PYZus{}T}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{real}\PY{p}{)}
\end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}19}]:} \PY{k+kn}{import} \PY{n+nn}{seaborn} \PY{k}{as} \PY{n+nn}{sns}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}19}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a17c6beb8>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_27_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}20}]:} \PY{c+c1}{\PYZsh{} plot sample covariance matrix to compare}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}20}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1a13afd0>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_28_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}21}]:} \PY{c+c1}{\PYZsh{} compute ground truth covariance matrix to compare}
         \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
         \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
         \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
         \PY{n}{sns}\PY{o}{.}\PY{n}{heatmap}\PY{p}{(}\PY{n}{cov\PYZus{}truth}\PY{p}{,} \PY{n}{xticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{yticklabels}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}21}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x181551ee48>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_29_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The heatmaps above look almost indistinguishable after eliminating all
other components.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}22}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industry} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                     \PY{n}{market}\PY{p}{,}
                                                                     \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                     \PY{n}{i}\PY{p}{,}
                                                                     \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                     \PY{n}{p\PYZus{}year}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industry}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground thruth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} standard sample moments}
             \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} PCA}
             \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{pc\PYZus{}cov}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{n}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{pc\PYZus{}cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is:  23.374207157554075
IR gt\_oos:  24.22487984962384

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  82.50759694936612
IR sm\_oos:  7.0057612696101375
IR pca\_is:  22.216859381000006
IR pca\_oos:  22.595827859949612
MC run:  1
IR gt\_is:  25.418134789859575
IR gt\_oos:  24.240600658640563
IR sm\_is:  95.76372494651923
IR sm\_oos:  5.958420678047078
IR pca\_is:  23.91078700478066
IR pca\_oos:  22.990440378515917
MC run:  2
IR gt\_is:  23.56364989642909
IR gt\_oos:  23.990022007140244
IR sm\_is:  79.0767690999176
IR sm\_oos:  6.901858131089847
IR pca\_is:  21.420330187631972
IR pca\_oos:  22.030064199104288
MC run:  3
IR gt\_is:  23.3874383590086
IR gt\_oos:  25.244127982411683
IR sm\_is:  70.68916364298254
IR sm\_oos:  7.902184405991386
IR pca\_is:  21.75082366746542
IR pca\_oos:  24.393423066434213
MC run:  4
IR gt\_is:  27.290745199005972
IR gt\_oos:  25.02578210149913
IR sm\_is:  85.04175309422818
IR sm\_oos:  8.154456369030104
IR pca\_is:  26.925445403425606
IR pca\_oos:  22.825455393641207

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}23}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PCA}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. PCA }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_32_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}24}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS PCA / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS PCA / Markowitz:  3.1967327651604864

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}25}]:} \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{cov}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{matrix\PYZus{}rank}\PY{p}{(}\PY{n}{pc\PYZus{}cov}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
450
11

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}26}]:} \PY{n}{pf} \PY{o}{=} \PY{n}{Portfolio}\PY{p}{(}\PY{n}{assets}\PY{o}{=}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                        \PY{n}{position}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{weights}\PY{p}{)}\PY{p}{,}
                        \PY{n}{price}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,}
                        \PY{n}{sector\PYZus{}id}\PY{o}{=}\PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{str}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{n}{pf}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest long:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{largest short:}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{position}\PY{p}{(}\PY{n}{pf}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{sector\PYZus{}net\PYZus{}exposures:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{pf}\PY{o}{.}\PY{n}{sector\PYZus{}net\PYZus{}exposures}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
Portfolio: 450 Assets, \$130.53 Long, \$130.53 Short
largest long: manufacturing\_stock\_40 0.9044735707106419
largest short: insurance\_stock\_31 -0.8883571288891736
sector\_net\_exposures:
            position\_value
sector\_id
aut             -0.595581
ban             -0.018102
bio              2.715188
ins             -1.293434
man              0.030597
oil              2.145395
pha             -2.739619
ret              1.563692
tec             -1.808135

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}27}]:} \PY{n}{pf}\PY{o}{.}\PY{n}{portfolio\PYZus{}df}\PY{o}{.}\PY{n}{position\PYZus{}value}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{style}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{.}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}27}]:} <matplotlib.axes.\_subplots.AxesSubplot at 0x1a1a506f28>
\end{Verbatim}
            
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_36_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    PCA reduced extreme positions and set a lot fewer weights close to zero.

    \hypertarget{robustness-under-fat-tailed-noise-distribution}{%
\subsection{Robustness under fat-tailed noise
distribution}\label{robustness-under-fat-tailed-noise-distribution}}

The Generalized Autoregressive Conditional Heteroskedasticity (GARCH)
model is defined by:

\(\begin{aligned} r_{t} &=\mu_{t}+\epsilon_{t} \\ \epsilon_{t} &=\sigma_{t} \eta_{t}, \quad \eta_{t} \stackrel{i i d}{\sim}(0,1) \\ \sigma_{t}^{2} &=\omega+\sum_{i=1}^{q} \alpha_{i} \epsilon_{t-i}^{2}+\sum_{i=1}^{p} \beta_{i} \sigma_{t-i}^{2} \\ \omega &>0, \quad \alpha_{i} \geq 0, \quad i=1, \ldots, q, \quad \beta_{i} \geq 0, \quad i=1, \ldots, p \end{aligned}\)

The unconditional variance becomes:

\(\begin{aligned} \mathrm{E}\left(\sigma_{t}^{2}\right) &=\omega+\sum_{i=1}^{q} \alpha_{i} \mathrm{E}\left(\epsilon_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\sum_{i=1}^{q} \alpha_{i} \mathrm{E}\left(\eta_{t-i}^{2} \sigma_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\sum_{i=1}^{q} \alpha_{i} \underbrace{\mathrm{E}\left(\eta_{t-i}^{2}\right)}_{=1} \mathrm{E}\left(\sigma_{t-i}^{2}\right)+\sum_{i=1}^{p} \beta_{i} \mathrm{E}\left(\sigma_{t-i}^{2}\right) \\ &=\omega+\left(\sum_{i=1}^{q} \alpha_{i}+\sum_{i=1}^{p} \beta_{i}\right) \mathrm{E}\left(\sigma_{t}^{2}\right) \end{aligned}\)

\(\begin{array}{l}{\text { Solving for } \mathrm{E}\left(\sigma_{t}^{2}\right), \text { we have the unconditional variance }} \\ {\qquad \begin{aligned} \mathrm{E}\left(\epsilon_{t}^{2}\right) &=\mathrm{E}\left(\sigma_{t}^{2}\right) \\ &=\frac{\omega}{1-\sum_{i=1}^{q} \alpha_{i}-\sum_{i=1}^{p} \beta_{i}} \end{aligned}}\end{array}\)

Equity curves under this nise distribution look like this.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}36}]:} \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         \PY{n}{banks} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         \PY{n}{stocks}\PY{p}{,} \PY{o}{*}\PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,} \PY{n}{market}\PY{p}{,} \PY{n}{banks}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                                       \PY{n}{sigma\PYZus{}noise}\PY{p}{,} \PY{n}{p\PYZus{}year}\PY{p}{,} \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                       \PY{n}{garch\PYZus{}alpha}\PY{p}{,} \PY{n}{garch\PYZus{}beta}\PY{p}{)}
         \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks}\PY{p}{)}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_39_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    As you can see, returns are much more extreme than under Gaussian noise.

First let's compare Markowitz vs.~hierachrichal vs.~equal weighting
under a GARCH(1,1) noise distribution.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}28}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                           \PY{n}{market}\PY{p}{,}
                                                                           \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                           \PY{n}{i}\PY{p}{,}
                                                                           \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                           \PY{n}{p\PYZus{}year}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}alpha}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}beta}\PY{p}{)}
         
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
                 \PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                              \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                              \PY{k+kc}{True}\PY{p}{,}
                                              \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                              \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
         \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                              \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
                 \PY{n}{industries\PYZus{}portfolio}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                                  \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}weights}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground truth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} GARCH uncond Var}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{p}{(}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}alpha}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}beta}\PY{p}{)}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{}standard sample moments}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,}
                                                  \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} hierarchical}
             \PY{c+c1}{\PYZsh{} optimize allocation to industry}
             \PY{n}{industry\PYZus{}weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                          \PY{k+kc}{False}\PY{p}{,}
                                                          \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{n}{index}\PY{o}{=}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{,}
                                                          \PY{n}{data}\PY{o}{=}\PY{p}{[}\PY{l+m+mf}{0.1}\PY{p}{]}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
         \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{p}{,}
                                                          \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}     \PYZsh{} equal weighting industries}
         \PY{c+c1}{\PYZsh{}     for i in industry\PYZus{}weights.keys():}
         \PY{c+c1}{\PYZsh{}         industry\PYZus{}weights[i] = 1/len(industries)}
         
             \PY{n+nb}{print}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}hier\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}hier\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{industries\PYZus{}portfolio}\PY{p}{)}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industry\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}hier\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR hier\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{apply}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sign}\PY{p}{)}\PY{o}{/}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
         
             \PY{c+c1}{\PYZsh{} Make same gross leverage}
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} Make same gross leverage}
             \PY{n}{equal\PYZus{}weights} \PY{o}{=} \PY{n}{equal\PYZus{}weights}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}equal} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{equal\PYZus{}weights}\PY{o}{.}\PY{n}{values}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}is} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{portfolio\PYZus{}equal\PYZus{}oos} \PY{o}{=} \PY{n}{portfolio\PYZus{}equal}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}equal\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR equal\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is:  10.314924137730154
IR gt\_oos:  11.219773222633183

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  44.07406918703761
IR sm\_oos:  3.299182310696336
\{'banks': 0.15967829378891055, 'oil': 0.1636020654087193, 'insurance':
0.04078337564155619, 'tech': 0.2508566420893103, 'bio': 0.09343134145129015, 'pharma':
0.05204879547856919, 'auto': 0.053656763591487855, 'retail': 0.15069582320238875,
'manufacturing': 0.03524689934776772\}
IR hier\_is:  10.687466946383722
IR hier\_oos:  10.355871865738731
IR equal\_is:  8.646609676920752
IR equal\_oos:  7.736393224746492
MC run:  1
IR gt\_is:  10.174839063328545
IR gt\_oos:  9.964522319055435
IR sm\_is:  33.77882119655665
IR sm\_oos:  2.4542785693304356
\{'banks': 0.0795117291238569, 'oil': 0.14235509568143997, 'insurance':
0.14007480362066402, 'tech': 0.06853274182949477, 'bio': 0.08809651316811047,
'pharma': 0.20047352348159514, 'auto': 0.07015826481167935, 'retail':
0.16301195251625608, 'manufacturing': 0.04778537576690336\}
IR hier\_is:  10.98426987771284
IR hier\_oos:  8.69865353488074
IR equal\_is:  8.060779706831138
IR equal\_oos:  7.9023600364309345
MC run:  2
IR gt\_is:  11.584320797566154
IR gt\_oos:  10.713938421161808
IR sm\_is:  61.391905413003606
IR sm\_oos:  2.77196109978414
\{'banks': 0.11744003832461196, 'oil': 0.0833591642101323, 'insurance':
0.04207044533458641, 'tech': 0.15800493451150344, 'bio': 0.19528268451668537,
'pharma': 0.18413031367391863, 'auto': 0.055619872788576386, 'retail':
0.1033814383975889, 'manufacturing': 0.06071110824239664\}
IR hier\_is:  12.567557047983506
IR hier\_oos:  8.935635490111618
IR equal\_is:  7.163851823883613
IR equal\_oos:  6.89399462412708
MC run:  3
IR gt\_is:  10.510696822965606
IR gt\_oos:  9.917822616448193
IR sm\_is:  23.24424801054156
IR sm\_oos:  2.85689345810808
\{'banks': 0.057071875629943064, 'oil': 0.13811942257648732, 'insurance':
0.06719395752458439, 'tech': 0.10928283339768104, 'bio': 0.1724985366005242, 'pharma':
0.14528957407974658, 'auto': 0.09567592998414085, 'retail': 0.05167713025092805,
'manufacturing': 0.16319073995596442\}
IR hier\_is:  11.392469285226964
IR hier\_oos:  8.57303516322006
IR equal\_is:  6.9072710495518
IR equal\_oos:  5.615288496477106
MC run:  4
IR gt\_is:  9.412876464600133
IR gt\_oos:  10.85642244057754
IR sm\_is:  31.691928838527556
IR sm\_oos:  3.6671934307537186
\{'banks': 0.07644752817679888, 'oil': 0.17235966474892608, 'insurance':
0.05912214359740948, 'tech': 0.06594169325594036, 'bio': 0.06702133246179037,
'pharma': 0.3639364249129581, 'auto': 0.07309227555950167, 'retail':
0.032910189667125986, 'manufacturing': 0.08916874761954892\}
IR hier\_is:  10.165432999344953
IR hier\_oos:  8.796881195995462
IR equal\_is:  6.183074202060472
IR equal\_oos:  6.44793905253365

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}29}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Hierarchical}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Equal Weighted}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. Hierarchical }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_42_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}30}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Markowitz:  3.014056979917056

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}31}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Equal / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Equal / Markowitz:  2.298810927068244

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}32}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}hier\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}equal\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS Hierarchical / Equal: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS Hierarchical / Equal:  1.3111373990904904

    \end{Verbatim}

    Under fat-tails Markowitz performs even worse since extreme positions
expose the portfolio to asset specific tail risk. In particular,
Markowitz underperforms equal weighting significantly. The hierarchical
method still outperforms equal weighting, though.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}33}]:} \PY{n}{trainig\PYZus{}pct} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{n\PYZus{}train} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{trainig\PYZus{}pct}\PY{o}{*}\PY{n}{num\PYZus{}samples}\PY{p}{)}
         \PY{n}{ir\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{ir\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{n}{n\PYZus{}stocks} \PY{o}{=} \PY{l+m+mi}{50}
         
         \PY{n}{garch\PYZus{}mu} \PY{o}{=} \PY{l+m+mi}{0}
         \PY{n}{garch\PYZus{}alpha} \PY{o}{=} \PY{l+m+mf}{0.5}
         \PY{n}{garch\PYZus{}beta} \PY{o}{=} \PY{l+m+mf}{0.3}
         
         \PY{k}{for} \PY{n}{j} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{MC\PYZus{}RUNS}\PY{p}{)}\PY{p}{:}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{MC run: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{j}\PY{p}{)}
         
             \PY{n}{market} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{market}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=}  \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{banks}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{oil}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{insurance}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{tech}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{bio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pharma}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{auto}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{retail}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
             \PY{n}{industries}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{n}{size}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}
         \PY{n}{num\PYZus{}samples}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{sigma}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{manufacturing}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
             \PY{n}{industries\PYZus{}stocks} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}mu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}market} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}beta\PYZus{}industries} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}weights} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
             \PY{n}{industries\PYZus{}portfolio} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
         
             \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{p}{)}
             \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Series}\PY{p}{(}\PY{p}{)}
         
             \PY{n}{B} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{sigma}\PY{p}{)}\PY{p}{)}\PY{p}{)}
             \PY{k}{for} \PY{n}{n}\PY{p}{,} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{industries}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{:}
                 \PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}\PYZbs{}
                 \PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]} \PY{o}{=} \PY{n}{gen\PYZus{}industry\PYZus{}stocks\PYZus{}garch}\PY{p}{(}\PY{n}{n\PYZus{}stocks}\PY{p}{,}
                                                                           \PY{n}{market}\PY{p}{,}
                                                                           \PY{n}{industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,}
                                                                           \PY{n}{i}\PY{p}{,}
                                                                           \PY{n}{sigma\PYZus{}noise}\PY{p}{,}
                                                                           \PY{n}{p\PYZus{}year}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}mu}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}alpha}\PY{p}{,}
                                                                           \PY{n}{garch\PYZus{}beta}
                                                                           \PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}market}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{B}\PY{p}{[}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{n}{n}\PY{p}{:}\PY{n}{n\PYZus{}stocks}\PY{o}{*}\PY{p}{(}\PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{n}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=}
         \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{industries\PYZus{}beta\PYZus{}industries}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{)}
         
                 \PY{n}{stocks\PYZus{}all} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{concat}\PY{p}{(}\PY{p}{[}\PY{n}{stocks\PYZus{}all}\PY{p}{,}\PY{n}{industries\PYZus{}stocks}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{expected\PYZus{}returns\PYZus{}all} \PY{o}{=} \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{industries\PYZus{}mu}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
         
             \PY{k}{if} \PY{n}{PLOT\PYZus{}STOCKS}\PY{p}{:}
                 \PY{n}{plot\PYZus{}equity\PYZus{}curve}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} ground truth}
             \PY{n}{Sigma\PYZus{}f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{n}{sigma}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{sigma}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{]}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} GARCH uncond Var}
             \PY{n}{Sigma\PYZus{}e} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{diag}\PY{p}{(}\PY{p}{[}\PY{p}{(}\PY{n}{sigma\PYZus{}noise}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}alpha}\PY{o}{\PYZhy{}}\PY{n}{garch\PYZus{}beta}\PY{p}{)}\PY{p}{]}\PY{o}{*}\PY{n}{B}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{cov\PYZus{}truth} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{DataFrame}\PY{p}{(}\PY{n}{B}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{Sigma\PYZus{}f}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{transpose}\PY{p}{(}\PY{n}{B}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{Sigma\PYZus{}e}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov\PYZus{}truth}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}is}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}gt\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}gt\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR gt\PYZus{}oos}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} standard sample moments}
             \PY{n}{cov} \PY{o}{=} \PY{n}{stocks\PYZus{}all}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{cov}\PY{p}{(}\PY{p}{)}
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                  \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                  \PY{k+kc}{True}\PY{p}{,}
                                                  \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                  \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{cov}\PY{p}{,}
                                                  \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                      \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}is}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}sm\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}sm\PYZus{}oos}\PY{p}{)}
             \PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR sm\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{} PCA}
             \PY{n}{n} \PY{o}{=} \PY{n+nb}{len}\PY{p}{(}\PY{n}{industries}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{pc\PYZus{}cov} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{pc\PYZus{}cov}\PY{p}{(}\PY{n}{cov}\PY{p}{,} \PY{n}{n}\PY{p}{)}
         
             \PY{n}{weights} \PY{o}{=} \PY{n}{optimize}\PY{o}{.}\PY{n}{minimize\PYZus{}objective}\PY{p}{(}\PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{o}{.}\PY{n}{index}\PY{p}{,}
                                                   \PY{n}{optimize}\PY{o}{.}\PY{n}{negative\PYZus{}sharpe}\PY{p}{,}
                                                   \PY{k+kc}{True}\PY{p}{,}
                                                   \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,}
                                                   \PY{n}{expected\PYZus{}returns\PYZus{}all}\PY{p}{,} \PY{n}{pc\PYZus{}cov}\PY{p}{,}
                                                   \PY{l+m+mf}{0.0}\PY{p}{,} \PY{l+m+mf}{0.0}\PY{p}{,}\PY{p}{)}
         
             \PY{n}{portfolio\PYZus{}pca\PYZus{}is} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                       \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{n}{n\PYZus{}train}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}is}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}is: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{portfolio\PYZus{}pca\PYZus{}oos} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{stocks\PYZus{}all}\PY{o}{.}\PY{n}{values}\PY{p}{,}
                                        \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{list}\PY{p}{(}\PY{n}{weights}\PY{o}{.}\PY{n}{values}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{n}{n\PYZus{}train}\PY{p}{:}\PY{p}{]}
             \PY{n}{IR\PYZus{}ann} \PY{o}{=} \PY{n}{information\PYZus{}ratio}\PY{p}{(}\PY{n}{portfolio\PYZus{}pca\PYZus{}oos}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IR pca\PYZus{}oos: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{IR\PYZus{}ann}\PY{p}{)}
             \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{IR\PYZus{}ann}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
MC run:  0
IR gt\_is 10.758594652817013
IR gt\_oos 11.113050819241867

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
/Users/jan/Documents/PoCon/src/optimize.py:30: UserWarning: Optimizer did not
converge.
  warnings.warn("Optimizer did not converge.")

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
IR sm\_is:  45.786748204016575
IR sm\_oos:  2.1310671782905524
IR pca\_is:  10.318541498885843
IR pca\_oos:  10.98982646744523
MC run:  1
IR gt\_is 10.67688681381962
IR gt\_oos 11.421483144077598
IR sm\_is:  48.90253528100965
IR sm\_oos:  3.051585524228475
IR pca\_is:  10.247278634275052
IR pca\_oos:  10.41375102506033
MC run:  2
IR gt\_is 12.176829836445028
IR gt\_oos 12.06736269017553
IR sm\_is:  30.738471183724553
IR sm\_oos:  3.7438989461220653
IR pca\_is:  11.642604559997816
IR pca\_oos:  11.422175067044499
MC run:  3
IR gt\_is 10.53346113430525
IR gt\_oos 9.854214602957956
IR sm\_is:  33.7132282314814
IR sm\_oos:  3.7362309737404167
IR pca\_is:  9.563417908861911
IR pca\_oos:  8.58128351620866
MC run:  4
IR gt\_is 10.431839695937438
IR gt\_oos 10.994779704295947
IR sm\_is:  44.819303024148425
IR sm\_oos:  3.5385970189220033
IR pca\_is:  9.753478592732034
IR pca\_oos:  10.152142979890636

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}34}]:} \PY{n}{performance\PYZus{}factor} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{)}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{)}
         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS PCA / Markowitz: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{performance\PYZus{}factor}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\},fontsize=\footnotesize]
OOS PCA / Markowitz:  3.1823943514171646

    \end{Verbatim}

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor}35}]:} \PY{n}{data\PYZus{}a} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}is}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}is}\PY{p}{]}
         \PY{n}{data\PYZus{}b} \PY{o}{=} \PY{p}{[}\PY{n}{ir\PYZus{}sm\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}pca\PYZus{}oos}\PY{p}{,} \PY{n}{ir\PYZus{}gt\PYZus{}oos}\PY{p}{]}
         
         \PY{n}{ticks} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PCA}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Ground Truth}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
         
         \PY{k}{def} \PY{n+nf}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp}\PY{p}{,} \PY{n}{color}\PY{p}{)}\PY{p}{:}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{boxes}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{whiskers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{caps}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
             \PY{n}{plt}\PY{o}{.}\PY{n}{setp}\PY{p}{(}\PY{n}{bp}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{medians}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{n}{color}\PY{p}{)}
         
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         
         \PY{n}{bp1} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}a}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         \PY{n}{bp2} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{boxplot}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{,} \PY{n}{positions}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{data\PYZus{}b}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{2.0}\PY{o}{+}\PY{l+m+mf}{0.4}\PY{p}{,} \PY{n}{sym}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
         \PY{n}{widths}\PY{o}{=}\PY{l+m+mf}{0.6}\PY{p}{)}
         
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp1}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} colors are from http://colorbrewer2.org/}
         \PY{n}{set\PYZus{}box\PYZus{}color}\PY{p}{(}\PY{n}{bp2}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} draw temporary red and blue lines and use them to create a legend}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}D7191C}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{IS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{n}{c}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZsh{}2C7BB6}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{label}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{OOS}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{legend}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Markowitz vs. PCA }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Information Ratio}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{n}{ticks}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{xlim}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,} \PY{n+nb}{len}\PY{p}{(}\PY{n}{ticks}\PY{p}{)}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.ylim(0, 8)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}boxcompare.png\PYZsq{})}
\end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{demo_files/demo_49_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The PCA method, too, outperforms Markowitz by a large margin under
fat-tails.

    \hypertarget{conclusion}{%
\subsection{Conclusion}\label{conclusion}}

Industry neutral equal weighting can go a long way. If the number of
assets is large, it tends to outperform mean-variance optimization based
on sample moments. It certainly is better than long-only portfolio
construction. If one is willing to invest the effort to go beyond naive
approaches, imposing structure by hierarchical methods, shrinkage
estimation or noise reduction via PCA seem to be good approaches based
on monte carlo evidence. In addition, I showed that these methods are
robust to asset-specific fat-tailed noise by having fewer extreme and
instead more numerous moderate position weights.

   \begin{Verbatim}[commandchars=\\\{\},fontsize=\scriptsize]
{\color{incolor}In [{\color{incolor} }]:} 
\end{Verbatim}


    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
